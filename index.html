<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LabTrack â€” Lab Inventory</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=IBM+Plex+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg0:#07090f; --bg1:#0d1117; --bg2:#141b24; --bg3:#1c2535; --bg4:#222e42;
  --border:#1e2d42; --border-hi:#2d4060;
  --text:#e8edf5; --sub:#7a8fa6; --dim:#3d5068;
  --cyan:#00d4c8; --cyan-d:#00332f; --cyan-m:#009e97;
  --amber:#f5a623; --amber-d:#3d2900;
  --red:#ff4d6a; --red-d:#2d0010;
  --green:#00e676; --green-d:#003322;
  --blue:#4da6ff; --blue-d:#0a1f3d;
  --purple:#b47dff; --purple-d:#1a0e2e;
  --orange:#ff8c42; --orange-d:#2d1800;
}
body{background:var(--bg0);color:var(--text);font-family:'Outfit',sans-serif;margin:0;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg1);}
::-webkit-scrollbar-thumb{background:var(--border-hi);border-radius:3px;}
select option{background:var(--bg2);}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(0.5);}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes toastSlide{from{opacity:0;transform:translateY(14px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

.card-item{transition:all .2s cubic-bezier(.4,0,.2,1);cursor:pointer;}
.card-item:hover{transform:translateY(-3px);box-shadow:0 14px 36px rgba(0,0,0,.55),0 0 0 1px rgba(0,212,200,.1);border-color:var(--border-hi)!important;}
.row-hover:hover{background:var(--bg3)!important;}
.ibtn:hover{background:var(--bg3)!important;color:var(--text)!important;}
.chip-sel{background:var(--cyan-d)!important;color:var(--cyan)!important;border-color:var(--cyan-m)!important;}
.item-sel-row{background:var(--cyan-d)!important;border-color:var(--cyan-m)!important;}
.item-sel-row:hover{background:var(--cyan-d)!important;}
.overdue-pulse{animation:pulse 2s infinite;}
.sticky-th{position:sticky;top:0;background:var(--bg2);z-index:1;}
/* â”€â”€ Light mode â”€â”€ */
html.light{
  --bg0:#f5f7fa;--bg1:#ffffff;--bg2:#edf2f7;--bg3:#e2e8f0;--bg4:#cbd5e0;
  --border:#c5d0db;--border-hi:#a0b4c8;
  --text:#1a202c;--sub:#4a5568;--dim:#94a3b8;
  --cyan-d:#e6fffd;--amber-d:#fffbeb;--red-d:#fff5f5;
  --green-d:#f0fff4;--blue-d:#ebf8ff;--purple-d:#faf5ff;--orange-d:#fff5f0;
}
html.light body{background:var(--bg0);color:var(--text);}
html.light ::-webkit-scrollbar-track{background:var(--bg1);}
html.light ::-webkit-scrollbar-thumb{background:var(--border-hi);}
html.light select option{background:var(--bg2);}
html.light input[type=date]::-webkit-calendar-picker-indicator{filter:none;}
html.light .card-item:hover{box-shadow:0 8px 24px rgba(0,0,0,.12),0 0 0 1px rgba(0,212,200,.25);}
html.light .sticky-th{background:var(--bg2);}
html.light .row-hover:hover{background:var(--bg3)!important;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useRef, useEffect, useCallback, useMemo } = React;

// â”€â”€â”€ DYNAMIC DATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getToday = () => new Date().toISOString().slice(0,10);
const getTodayParts = () => {
  const d = new Date();
  return { d: d.getDate(), m: d.getMonth(), y: d.getFullYear() };
};

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_CONFIG = {
  oauth_client_id: "253618186533-8b7mt0hgcgdb4qlh8tg2admilfifuhgq.apps.googleusercontent.com",
  apps_script_url: "https://script.google.com/macros/s/AKfycbzLLvwOatqT3j5XRvUD3_DPoFzip1GVp9o17XY31bXrxi5wCyUkm8OXcS5IC3AysXsVBw/exec",
};

const DEFAULT_CATEGORIES = ["Robots & Motors","Sensors & Vision","Compute & Electronics","Wiring & Networking","Tools & Hardware","Consumables & Supplies","Safety & Facility","Other"];
const ITEMS_PER_PAGE = 24;

const CAT_PALETTE = ["var(--cyan)","var(--purple)","var(--amber)","var(--green)","var(--blue)","var(--orange)","var(--red)","#e879f9","#67e8f9","var(--sub)"];
const getCatAccent = (cat, categories) => {
  const idx = categories.indexOf(cat);
  if (idx < 0) return "var(--sub)";
  return CAT_PALETTE[idx % CAT_PALETTE.length];
};

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isOverdue = (co) => co.status === "Active" && co.ret && co.ret < getToday();
const STATUS_C = {
  "Available":  {bg:"var(--green-d)", t:"var(--green)",  b:"#00e67628"},
  "In Use":     {bg:"var(--blue-d)",  t:"var(--blue)",   b:"#4da6ff28"},
  "Maintenance":{bg:"var(--amber-d)", t:"var(--amber)",  b:"#f5a62328"},
  "Broken":     {bg:"var(--red-d)",   t:"var(--red)",    b:"#ff4d6a28"},
  "Low Stock":  {bg:"var(--red-d)",   t:"var(--red)",    b:"#ff4d6a28"},
  "Logged":     {bg:"var(--green-d)", t:"var(--green)",  b:"#00e67628"},
  "Active":     {bg:"var(--blue-d)",  t:"var(--blue)",   b:"#4da6ff28"},
  "Returned":   {bg:"var(--bg4)",     t:"var(--sub)",    b:"var(--border)"},
  "Overdue":    {bg:"var(--red-d)",   t:"var(--red)",    b:"#ff4d6a28"},
};

// â”€â”€â”€ IMAGE COMPRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const compressImage = (file) => new Promise((resolve) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      let w = img.width, h = img.height;
      if (w > 400) { h = Math.round(h * 400 / w); w = 400; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL("image/jpeg", 0.7));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
});

// â”€â”€â”€ SVG ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const P = {
  box:'<path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>',
  truck:'<rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>',
  users:'<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>',
  calendar:'<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>',
  settings:'<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>',
  plus:'<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
  check:'<polyline points="20 6 9 17 4 12"/>',
  x:'<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
  alert:'<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
  search:'<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
  grid:'<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>',
  list:'<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
  undo:'<polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/>',
  layers:'<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
  bell:'<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>',
  clock:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
  tag:'<path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/>',
  keyboard:'<rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M8 14h8"/>',
  logout:'<path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>',
  edit:'<path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>',
  cart:'<circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>',
  trash:'<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>',
  camera:'<path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/>',
  upload:'<polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/>',
  link:'<path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>',
  sort:'<line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/>',
  chevL:'<polyline points="15 18 9 12 15 6"/>',
  chevR:'<polyline points="9 18 15 12 9 6"/>',
  moon:'<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>',
  sun:'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
  bell2:'<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/><line x1="12" y1="2" x2="12" y2="8"/>',
  mail:'<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
  copy:'<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>',
};
const Ico = ({n,s=16,col="currentColor"}) => (
  React.createElement('svg', {width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:col,
    strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{flexShrink:0},
    dangerouslySetInnerHTML:{__html:P[n]||""}})
);

// â”€â”€â”€ BACKEND API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = {
  async fetchAll(token) {
    if (!APP_CONFIG.apps_script_url) return null;
    try {
      const url = APP_CONFIG.apps_script_url + "?token=" + encodeURIComponent(token);
      const r = await fetch(url, { redirect: "follow" });
      const text = await r.text();
      try { return JSON.parse(text); } catch { console.error("[API] Not JSON:", text.slice(0, 500)); return null; }
    } catch(e) { console.error("[API] fetchAll error:", e); return null; }
  },
  async post(token, action, payload) {
    if (!APP_CONFIG.apps_script_url) return null;
    try {
      const body = JSON.stringify({ token, action, ...payload });
      const r = await fetch(APP_CONFIG.apps_script_url, {
        method: "POST", body: body, redirect: "follow",
      });
      const text = await r.text();
      try { return JSON.parse(text); } catch { return { ok: true }; }
    } catch(e) { console.error("[API] post error:", e); return null; }
  }
};

// â”€â”€â”€ ATOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Badge = ({status}) => {
  const c = STATUS_C[status]||STATUS_C["Available"];
  return <span style={{background:c.bg,color:c.t,border:`1px solid ${c.b}`,padding:"2px 9px",borderRadius:20,fontSize:10,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace",whiteSpace:"nowrap"}}>{status}</span>;
};
const MemberAvatar = ({name,sz=32}) => {
  const hue = name.split("").reduce((a,c)=>a+c.charCodeAt(0),0)%360;
  const initials = name.split(" ").map(w=>w[0]).join("").slice(0,2);
  return <div style={{width:sz,height:sz,borderRadius:"50%",flexShrink:0,background:`hsl(${hue},50%,22%)`,border:`2px solid hsl(${hue},50%,38%)`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:sz*.36,color:`hsl(${hue},65%,82%)`,fontFamily:"'Roboto',sans-serif"}}>{initials}</div>;
};
const Inp = ({style,...p}) => (
  <input style={{width:"100%",background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"9px 12px",fontSize:14,outline:"none",fontFamily:"'Outfit',sans-serif",transition:"border-color .15s",...style}}
    onFocus={e=>e.target.style.borderColor="var(--cyan-m)"}
    onBlur={e=>e.target.style.borderColor="var(--border)"}
    {...p}/>
);
const Sel = ({children,style,...p}) => (
  <select style={{width:"100%",background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"9px 12px",fontSize:14,outline:"none",fontFamily:"'Outfit',sans-serif",...style}} {...p}>{children}</select>
);
const Fld = ({label,hint,children}) => (
  <div style={{marginBottom:14}}>
    <label style={{display:"block",color:"var(--sub)",fontSize:10,fontWeight:700,letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:5,fontFamily:"'IBM Plex Mono',monospace"}}>{label}</label>
    {children}
    {hint&&<p style={{color:"var(--dim)",fontSize:11,marginTop:4}}>{hint}</p>}
  </div>
);
const Btn = ({children,onClick,v="primary",style,disabled,sm}) => {
  const VS={
    primary:{background:"var(--cyan)",color:"#000",border:"none"},
    ghost:{background:"transparent",color:"var(--sub)",border:"1px solid var(--border)"},
    danger:{background:"var(--red-d)",color:"var(--red)",border:"1px solid #ff4d6a30"},
    success:{background:"var(--green-d)",color:"var(--green)",border:"1px solid #00e67630"},
    amber:{background:"var(--amber-d)",color:"var(--amber)",border:"1px solid #f5a62330"},
  };
  return <button disabled={disabled} onClick={onClick} style={{...VS[v],borderRadius:8,padding:sm?"5px 11px":"9px 18px",fontSize:sm?11:14,fontWeight:600,cursor:disabled?"not-allowed":"pointer",opacity:disabled?.4:1,display:"inline-flex",alignItems:"center",gap:6,fontFamily:"'Outfit',sans-serif",transition:"all .15s",whiteSpace:"nowrap",...style}}>{children}</button>;
};

// â”€â”€â”€ MODAL SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Modal = ({onClose,title,mw=560,children,noPad}) => (
  <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(7,9,15,.88)",backdropFilter:"blur(7px)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"var(--bg1)",border:"1px solid var(--border-hi)",borderRadius:16,width:"100%",maxWidth:mw,maxHeight:"94vh",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 32px 80px rgba(0,0,0,.8),0 0 0 1px rgba(0,212,200,.05)",animation:"fadeUp .22s ease"}}>
      {title!==false&&(
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"20px 24px 16px",borderBottom:"1px solid var(--border)",flexShrink:0}}>
          <h2 style={{margin:0,color:"var(--text)",fontSize:17,fontFamily:"'Roboto',sans-serif",fontWeight:700}}>{title}</h2>
          <button onClick={onClose} className="ibtn" style={{background:"var(--bg2)",border:"1px solid var(--border)",color:"var(--sub)",borderRadius:8,padding:"5px 9px",cursor:"pointer",display:"flex",alignItems:"center",transition:"all .15s"}}><Ico n="x" s={14}/></button>
        </div>
      )}
      <div style={{overflow:"auto",flex:1,padding:noPad?"0":"24px"}}>{children}</div>
    </div>
  </div>
);

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ToastStack = ({toasts,rm}) => (
  <div style={{position:"fixed",bottom:24,right:24,zIndex:9999,display:"flex",flexDirection:"column",gap:8,minWidth:300,maxWidth:380}}>
    {toasts.map(t=>{
      const C={success:{bg:"var(--green-d)",col:"var(--green)",icon:"check"},error:{bg:"var(--red-d)",col:"var(--red)",icon:"alert"},info:{bg:"var(--blue-d)",col:"var(--blue)",icon:"bell"}}[t.type]||{};
      return(
        <div key={t.id} onClick={t.onClick||undefined} style={{background:C.bg,border:`1px solid ${C.col}33`,borderRadius:12,padding:"11px 15px",display:"flex",alignItems:"flex-start",gap:10,animation:"toastSlide .28s cubic-bezier(.4,0,.2,1)",boxShadow:"0 8px 32px rgba(0,0,0,.5)",cursor:t.onClick?"pointer":undefined}}>
          <span style={{color:C.col,marginTop:1,flexShrink:0}}><Ico n={C.icon} s={15} col={C.col}/></span>
          <span style={{color:"var(--text)",fontSize:13,flex:1,lineHeight:1.45}}>{t.msg}</span>
          <button onClick={e=>{e.stopPropagation();rm(t.id);}} style={{background:"none",border:"none",cursor:"pointer",color:"var(--dim)",padding:0,display:"flex"}}><Ico n="x" s={13}/></button>
        </div>
      );
    })}
  </div>
);

// â”€â”€â”€ IMAGE UPLOAD WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ImageUpload = ({value, onChange}) => {
  const fileRef = useRef(null);
  const cameraRef = useRef(null);
  const [showUrl, setShowUrl] = useState(false);
  const [urlVal, setUrlVal] = useState(value && !value.startsWith("data:") ? value : "");
  const preview = value || "";

  const handleFile = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const compressed = await compressImage(file);
    onChange(compressed);
  };

  return (
    <div>
      <input ref={fileRef} type="file" accept="image/*" style={{display:"none"}} onChange={handleFile}/>
      <input ref={cameraRef} type="file" accept="image/*" capture="environment" style={{display:"none"}} onChange={handleFile}/>
      <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
        {preview && <img src={preview} alt="Preview" style={{width:80,height:80,objectFit:"cover",borderRadius:10,border:"1px solid var(--border)"}}/>}
        <div style={{display:"flex",flexDirection:"column",gap:6}}>
          <div style={{display:"flex",gap:6}}>
            <Btn sm v="ghost" onClick={()=>fileRef.current?.click()}><Ico n="upload" s={12}/>Upload Photo</Btn>
            <Btn sm v="ghost" onClick={()=>cameraRef.current?.click()}><Ico n="camera" s={12}/>Take Photo</Btn>
          </div>
          {!showUrl ? (
            <button onClick={()=>setShowUrl(true)} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",fontSize:11,textAlign:"left",padding:0}}>Or paste URL...</button>
          ) : (
            <div style={{display:"flex",gap:4,alignItems:"center"}}>
              <Inp placeholder="https://..." value={urlVal} onChange={e=>{setUrlVal(e.target.value);onChange(e.target.value);}} style={{fontSize:12,padding:"5px 8px",width:200}}/>
              <button onClick={()=>{setShowUrl(false);}} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:0,display:"flex"}}><Ico n="x" s={13}/></button>
            </div>
          )}
          {preview && <button onClick={()=>{onChange("");setUrlVal("");}} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",fontSize:11,textAlign:"left",padding:0}}>Remove image</button>}
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ MANAGE CATEGORIES MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ManageCategoriesModal = ({categories, onSave, onClose}) => {
  const [cats, setCats] = useState([...categories]);
  const [prefixes, setPrefixes] = useState(()=>{try{return JSON.parse(localStorage.getItem("labtrack_catprefixes")||"{}");}catch{return {};}});
  const [newCat, setNewCat] = useState("");
  const autoP = c => {const words=c.split(/[\s&\/\-_]+/).filter(Boolean);return(words.length===1?words[0].slice(0,4):words.map(w=>w[0]).join("")).toUpperCase()||"GEN";};
  const addCat = () => {const t=newCat.trim();if(t&&!cats.includes(t)){setCats([...cats,t]);setNewCat("");}};
  const removeCat = (c) => setCats(cats.filter(x=>x!==c));
  const saveAll = () => {localStorage.setItem("labtrack_catprefixes",JSON.stringify(prefixes));onSave(cats);onClose();};
  return (
    <Modal onClose={onClose} title="Manage Categories" mw={460}>
      <div style={{color:"var(--dim)",fontSize:12,marginBottom:10}}>Optionally set a custom prefix per category â€” auto-generated from initials if left blank. Label IDs look like <span style={{color:"var(--cyan)",fontFamily:"'IBM Plex Mono',monospace"}}>RM-00001</span>, <span style={{color:"var(--cyan)",fontFamily:"'IBM Plex Mono',monospace"}}>SV-00042</span>.</div>
      <div style={{display:"grid",gridTemplateColumns:"1fr auto auto auto",alignItems:"center",gap:6,marginBottom:6,padding:"0 4px"}}>
        <span style={{color:"var(--dim)",fontSize:11,fontWeight:600}}>CATEGORY</span>
        <span style={{color:"var(--dim)",fontSize:11,fontWeight:600,textAlign:"center",width:72}}>PREFIX</span>
        <span style={{color:"var(--dim)",fontSize:11,fontWeight:600,textAlign:"center",width:80}}>PREVIEW</span>
        <span style={{width:20}}/>
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:6,marginBottom:16,maxHeight:300,overflow:"auto"}}>
        {cats.map(c=>(
          <div key={c} style={{display:"grid",gridTemplateColumns:"1fr auto auto auto",alignItems:"center",gap:6,background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:8,padding:"6px 10px"}}>
            <span style={{fontSize:14,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{c}</span>
            <input value={prefixes[c]||""} placeholder={autoP(c)} title="Custom prefix (letters only). Leave blank to auto-generate." onChange={e=>setPrefixes(p=>({...p,[c]:e.target.value.replace(/[^a-zA-Z]/g,"").toUpperCase().slice(0,5)}))} style={{width:72,background:"var(--bg0)",border:"1px solid var(--border)",borderRadius:6,padding:"3px 6px",color:"var(--cyan)",fontSize:12,fontFamily:"'IBM Plex Mono',monospace",textAlign:"center"}}/>
            <span style={{color:"var(--sub)",fontSize:11,fontFamily:"'IBM Plex Mono',monospace",width:80,textAlign:"center"}}>{(prefixes[c]||autoP(c))+"-00001"}</span>
            <button onClick={()=>removeCat(c)} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:0,display:"flex"}}><Ico n="x" s={14}/></button>
          </div>
        ))}
        {cats.length===0 && <div style={{color:"var(--dim)",fontSize:13,textAlign:"center",padding:16}}>No categories yet</div>}
      </div>
      <div style={{display:"flex",gap:8,marginBottom:16}}>
        <Inp placeholder="New category name..." value={newCat} onChange={e=>setNewCat(e.target.value)} onKeyDown={e=>{if(e.key==="Enter")addCat();}} style={{flex:1}}/>
        <Btn sm onClick={addCat} disabled={!newCat.trim()}><Ico n="plus" s={12} col="#000"/>Add</Btn>
      </div>
      <div style={{borderTop:"1px solid var(--border)",paddingTop:14,display:"flex",gap:10,justifyContent:"flex-end"}}>
        <Btn v="ghost" onClick={onClose}>Cancel</Btn>
        <Btn onClick={saveAll}><Ico n="check" s={14} col="#000"/>Save</Btn>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ SEARCHABLE ITEM PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ItemPicker = ({items, value, onChange, categories}) => {
  const [q, setQ] = useState("");
  const [cat, setCat] = useState("All");
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  const inputRef = useRef(null);
  const selected = items.find(i=>i.name===value);
  // Exclude: consumables (use "Use" button), broken/maintenance, and "In Use" non-shared items
  const avail = items.filter(i=>!i.consumable && i.status!=="Maintenance" && i.status!=="Broken" && !(i.status==="In Use"&&!i.shared));
  const filtered = avail.filter(i=>{
    const match = i.name.toLowerCase().includes(q.toLowerCase()) || i.loc?.toLowerCase().includes(q.toLowerCase()) || i.desc?.toLowerCase().includes(q.toLowerCase());
    return match && (cat==="All" || i.cat===cat);
  });
  useEffect(()=>{
    const handler=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};
    document.addEventListener("mousedown",handler);
    return()=>document.removeEventListener("mousedown",handler);
  },[]);
  useEffect(()=>{if(open&&inputRef.current)inputRef.current.focus();},[open]);
  const pick=(item)=>{onChange(item.name);setOpen(false);setQ("");};
  const ac = selected?getCatAccent(selected.cat,categories):"var(--dim)";
  return(
    <div ref={ref} style={{position:"relative"}}>
      <button type="button" onClick={()=>setOpen(o=>!o)} style={{width:"100%",background:"var(--bg3)",border:`1px solid ${open?"var(--cyan-m)":"var(--border)"}`,color:selected?"var(--text)":"var(--sub)",borderRadius:8,padding:"9px 12px",fontSize:14,fontFamily:"'Outfit',sans-serif",textAlign:"left",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between",gap:10,transition:"border-color .15s"}}>
        {selected?(
          <div style={{display:"flex",alignItems:"center",gap:10,flex:1,minWidth:0}}>
            <span style={{width:8,height:8,borderRadius:"50%",background:ac,flexShrink:0}}/>
            <span style={{fontWeight:600}}>{selected.name}</span>
            <span style={{color:"var(--dim)",fontSize:12,fontFamily:"'IBM Plex Mono',monospace"}}>{selected.loc}</span>
            <Badge status={selected.qty<=selected.minQty?"Low Stock":selected.status}/>
          </div>
        ):<span>Search or select an item...</span>}
        <span style={{color:"var(--dim)",fontSize:10,flexShrink:0}}>{open?"â–²":"â–¼"}</span>
      </button>
      {open&&(
        <div style={{position:"absolute",top:"calc(100% + 6px)",left:0,right:0,background:"var(--bg2)",border:"1px solid var(--border-hi)",borderRadius:12,zIndex:50,boxShadow:"0 16px 48px rgba(0,0,0,.7)",animation:"fadeUp .18s ease",overflow:"hidden"}}>
          <div style={{padding:"12px 12px 8px",borderBottom:"1px solid var(--border)"}}>
            <div style={{position:"relative"}}>
              <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)"}}><Ico n="search" s={14} col="var(--dim)"/></span>
              <input ref={inputRef} placeholder="Type item name, location..." value={q} onChange={e=>setQ(e.target.value)} style={{width:"100%",background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"8px 10px 8px 32px",fontSize:13,outline:"none",fontFamily:"'Outfit',sans-serif"}}/>
              {q&&<button onClick={()=>setQ("")} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:0,display:"flex"}}><Ico n="x" s={13}/></button>}
            </div>
          </div>
          <div style={{display:"flex",gap:6,padding:"8px 12px",flexWrap:"wrap",borderBottom:"1px solid var(--border)"}}>
            {["All",...categories].map(c=>{
              const count = c==="All"?avail.length:avail.filter(i=>i.cat===c).length;
              if(count===0&&c!=="All")return null;
              const isSel = cat===c;
              const ac2=getCatAccent(c,categories);
              return(<button key={c} onClick={()=>setCat(c)} style={{background:isSel?(c==="All"?"var(--bg4)":`${ac2}18`):"var(--bg3)",color:isSel?(c==="All"?"var(--text)":ac2):"var(--sub)",border:`1px solid ${isSel?(c==="All"?"var(--border-hi)":ac2):"var(--border)"}`,borderRadius:20,padding:"3px 10px",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"'Outfit',sans-serif",display:"flex",alignItems:"center",gap:5,transition:"all .15s"}}>{c} <span style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:10,opacity:.7}}>{count}</span></button>);
            })}
          </div>
          <div style={{maxHeight:280,overflow:"auto"}}>
            {filtered.length===0?(
              <div style={{padding:"24px 16px",textAlign:"center",color:"var(--dim)",fontSize:13}}>No items match "{q}"</div>
            ):filtered.map(item=>{
              const itemAc=getCatAccent(item.cat,categories);const low=item.qty<=item.minQty;const isSel=item.name===value;
              return(
                <div key={item.id} onClick={()=>pick(item)} className={isSel?"item-sel-row":"row-hover"} style={{padding:"10px 14px",cursor:"pointer",display:"flex",alignItems:"center",gap:12,borderBottom:"1px solid var(--border)",transition:"background .12s"}}>
                  <span style={{width:8,height:8,borderRadius:"50%",background:low?"var(--red)":itemAc,flexShrink:0}}/>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:600,fontSize:13,color:"var(--text)",marginBottom:1}}>{item.name}</div>
                    <div style={{color:"var(--dim)",fontSize:11,fontFamily:"'IBM Plex Mono',monospace"}}>{item.cat} Â· {item.loc}</div>
                  </div>
                  <div style={{textAlign:"right",flexShrink:0}}>
                    <div style={{fontSize:14,fontWeight:800,fontFamily:"'Roboto',sans-serif",color:low?"var(--red)":itemAc}}>{item.qty}</div>
                    <div style={{fontSize:10,color:"var(--dim)"}}>{item.unit}</div>
                  </div>
                  {(low||item.status==="In Use")&&<Badge status={low?"Low Stock":item.status}/>}
                  {isSel&&<Ico n="check" s={14} col="var(--cyan)"/>}
                </div>
              );
            })}
          </div>
          <div style={{padding:"8px 14px",borderTop:"1px solid var(--border)",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <span style={{color:"var(--dim)",fontSize:11}}>{filtered.length} item{filtered.length!==1?"s":""}</span>
            {value&&<button onClick={()=>{onChange("");setQ("");}} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",fontSize:11}}>Clear</button>}
          </div>
        </div>
      )}
    </div>
  );
};

// â”€â”€â”€ CHECKOUT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CheckoutModal = ({items,onClose,onAdd,preItem="",userName="",categories}) => {
  const [f,setF]=useState({item:preItem,user:userName,out:getToday(),ret:"",qty:1,notes:""});
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  const selected=items.find(i=>i.name===f.item);
  const maxQty=selected?.qty||1;
  return(
    <Modal onClose={onClose} title="Check Out Item" mw={620}>
      <div style={{display:"flex",flexDirection:"column",gap:16}}>
        <Fld label="Select Item"><ItemPicker items={items} value={f.item} onChange={v=>setF(p=>({...p,item:v,qty:1}))} categories={categories}/></Fld>
        {selected&&(
          <div style={{background:"var(--bg2)",border:`1px solid ${getCatAccent(selected.cat,categories)}30`,borderRadius:10,padding:"12px 14px",display:"flex",gap:14,alignItems:"flex-start",animation:"fadeIn .2s ease"}}>
            <img src={selected.img||`https://placehold.co/64x48/141b24/3d5068?text=${encodeURIComponent(selected.cat)}`} alt={selected.name} style={{width:64,height:48,objectFit:"cover",borderRadius:8,border:"1px solid var(--border)",flexShrink:0}}/>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontWeight:700,fontSize:14,color:"var(--text)",marginBottom:2}}>{selected.name}</div>
              <div style={{color:"var(--dim)",fontSize:12,marginBottom:6,fontFamily:"'IBM Plex Mono',monospace"}}>{selected.loc} Â· {selected.cat}</div>
              <span style={{color:"var(--sub)",fontSize:12}}>Available: <strong style={{color:selected.qty<=selected.minQty?"var(--red)":"var(--green)",fontFamily:"'IBM Plex Mono',monospace"}}>{selected.qty} {selected.unit}</strong></span>
            </div>
          </div>
        )}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <Fld label="Person"><Inp placeholder="Your name" value={f.user} onChange={s("user")}/></Fld>
          <Fld label={`Quantity ${selected?`(max ${maxQty})`:""}`}>
            <div style={{display:"flex",alignItems:"center",gap:8}}>
              <button onClick={()=>setF(p=>({...p,qty:Math.max(1,p.qty-1)}))} style={{background:"var(--bg4)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:6,padding:"8px 12px",cursor:"pointer",fontSize:16,lineHeight:1}}>-</button>
              <input type="number" min={1} max={maxQty} value={f.qty} onChange={e=>setF(p=>({...p,qty:Math.min(maxQty,Math.max(1,parseInt(e.target.value)||1))}))} style={{flex:1,background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:8,padding:"9px 12px",textAlign:"center",fontFamily:"'Roboto',sans-serif",fontWeight:700,fontSize:16,color:"var(--text)",outline:"none",MozAppearance:"textfield",WebkitAppearance:"none"}}/>
              <button onClick={()=>setF(p=>({...p,qty:Math.min(maxQty,p.qty+1)}))} style={{background:"var(--bg4)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:6,padding:"8px 12px",cursor:"pointer",fontSize:16,lineHeight:1}}>+</button>
            </div>
          </Fld>
          <Fld label="Checkout Date"><Inp type="date" value={f.out} onChange={s("out")}/></Fld>
          <Fld label="Return By"><Inp type="date" value={f.ret} onChange={s("ret")}/></Fld>
        </div>
        <Fld label="Notes (optional)"><Inp placeholder="Experiment, purpose, any notes..." value={f.notes} onChange={s("notes")}/></Fld>
        <div style={{borderTop:"1px solid var(--border)",paddingTop:14,display:"flex",gap:10,justifyContent:"flex-end"}}>
          <Btn v="ghost" onClick={onClose}>Cancel</Btn>
          <Btn onClick={()=>{if(f.item&&f.user){onAdd({id:Date.now(),...f,status:"Active"});onClose();}}} disabled={!f.item||!f.user}><Ico n="check" s={14} col="#000"/>Confirm Checkout</Btn>
        </div>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ DELIVERY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DeliveryModal = ({onClose,onAdd,userName=""}) => {
  const [f,setF]=useState({item:"",qty:"",unit:"boxes",from:"",receivedBy:userName,date:getToday(),tracking:""});
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  return(
    <Modal onClose={onClose} title="Log Package Delivery">
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div style={{gridColumn:"1/-1"}}><Fld label="Item / Package Name"><Inp placeholder="e.g. Intel RealSense D435" value={f.item} onChange={s("item")}/></Fld></div>
        <Fld label="Quantity"><Inp type="number" placeholder="0" value={f.qty} onChange={s("qty")}/></Fld>
        <Fld label="Unit"><Sel value={f.unit} onChange={s("unit")}>{["boxes","pcs","units","bottles","sets","rolls","kg","L"].map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <Fld label="Supplier"><Inp placeholder="Digi-Key, Mouser, Amazon..." value={f.from} onChange={s("from")}/></Fld>
        <Fld label="Received By"><Inp placeholder="Your name" value={f.receivedBy} onChange={s("receivedBy")}/></Fld>
        <Fld label="Date"><Inp type="date" value={f.date} onChange={s("date")}/></Fld>
        <Fld label="Tracking No."><Inp placeholder="Optional" value={f.tracking} onChange={s("tracking")}/></Fld>
      </div>
      <div style={{borderTop:"1px solid var(--border)",marginTop:4,paddingTop:16,display:"flex",gap:10,justifyContent:"flex-end"}}>
        <Btn v="ghost" onClick={onClose}>Cancel</Btn>
        <Btn onClick={()=>{if(f.item&&f.qty){onAdd({id:Date.now(),...f,status:"Logged"});onClose();}}} disabled={!f.item||!f.qty}><Ico n="check" s={14} col="#000"/>Log Delivery</Btn>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ ADD ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AddItemModal = ({onClose,onAdd,categories,allItems}) => {
  const [f,setF]=useState({name:"",cat:categories[0]||"Other",qty:"",unit:"units",loc:"",desc:"",minQty:"1",img:"",serial:"",shared:false,consumable:false});
  const [displayId,setDisplayId]=useState(()=>genDisplayId(categories[0]||"Other",allItems));
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  const chk=k=>e=>setF(p=>({...p,[k]:e.target.checked}));
  const onCatChange=e=>{setF(p=>({...p,cat:e.target.value}));setDisplayId(genDisplayId(e.target.value,allItems));};
  const CHKBOX=(label,key)=><label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"var(--sub)"}}><input type="checkbox" checked={f[key]} onChange={chk(key)} style={{accentColor:"var(--cyan)",width:14,height:14}}/>{label}</label>;
  return(
    <Modal onClose={onClose} title="Add Item">
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div style={{gridColumn:"1/-1"}}><Fld label="Item Name"><Inp placeholder="e.g. UR5 Robot Arm" value={f.name} onChange={s("name")}/></Fld></div>
        <Fld label="Category"><Sel value={f.cat} onChange={onCatChange}>{categories.map(c=><option key={c}>{c}</option>)}</Sel></Fld>
        <Fld label="Label ID" hint="Print on physical sticker"><Inp value={displayId} onChange={e=>setDisplayId(e.target.value)}/></Fld>
        <Fld label="Quantity"><Inp type="number" placeholder="0" value={f.qty} onChange={s("qty")}/></Fld>
        <Fld label="Unit"><Sel value={f.unit} onChange={s("unit")}>{["units","pcs","boxes","bottles","sets","rolls","kg","L","m"].map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <Fld label="Min Stock Alert"><Inp type="number" placeholder="1" value={f.minQty} onChange={s("minQty")}/></Fld>
        <div style={{gridColumn:"1/-1"}}><Fld label="Location"><Inp placeholder="Room 3A / Workbench 2 / Shelf C1" value={f.loc} onChange={s("loc")}/></Fld></div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Serial Number (optional)"><Inp placeholder="e.g. SN-2024-001" value={f.serial} onChange={s("serial")}/></Fld></div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Description"><Inp placeholder="Brief description..." value={f.desc} onChange={s("desc")}/></Fld></div>
        <div style={{gridColumn:"1/-1",display:"flex",gap:20,flexWrap:"wrap",padding:"4px 0"}}>{CHKBOX("Shared â€” multiple users simultaneously","shared")}{CHKBOX("Consumable â€” deduct qty, no checkout needed","consumable")}</div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Image"><ImageUpload value={f.img} onChange={v=>setF(p=>({...p,img:v}))}/></Fld></div>
      </div>
      <div style={{borderTop:"1px solid var(--border)",marginTop:4,paddingTop:16,display:"flex",gap:10,justifyContent:"flex-end"}}>
        <Btn v="ghost" onClick={onClose}>Cancel</Btn>
        <Btn onClick={()=>{if(f.name&&f.qty){onAdd({id:Date.now(),...f,qty:+f.qty,minQty:+f.minQty||1,status:"Available",usedBy:[],displayId});onClose();}}} disabled={!f.name||!f.qty}><Ico n="plus" s={14} col="#000"/>Add Item</Btn>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ EDIT ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EditItemModal = ({item,onClose,onSave,onDelete,categories,isAdmin}) => {
  const [f,setF]=useState({name:item.name,cat:item.cat,qty:String(item.qty),unit:item.unit,loc:item.loc||"",desc:item.desc||"",minQty:String(item.minQty||1),img:item.img||"",status:item.status,serial:item.serial||"",shared:item.shared||false,consumable:item.consumable||false,displayId:item.displayId||""});
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  const chk=k=>e=>setF(p=>({...p,[k]:e.target.checked}));
  const [confirmDel,setConfirmDel]=useState(false);
  const CHKBOX=(label,key)=><label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"var(--sub)"}}><input type="checkbox" checked={f[key]} onChange={chk(key)} style={{accentColor:"var(--cyan)",width:14,height:14}}/>{label}</label>;
  return(
    <Modal onClose={onClose} title="Edit Item" mw={560}>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div style={{gridColumn:"1/-1"}}><Fld label="Item Name"><Inp value={f.name} onChange={s("name")}/></Fld></div>
        <Fld label="Category"><Sel value={f.cat} onChange={s("cat")}>{categories.map(c=><option key={c}>{c}</option>)}</Sel></Fld>
        <Fld label="Status"><Sel value={f.status} onChange={s("status")}>{["Available","In Use","Maintenance","Broken","Low Stock"].map(st=><option key={st}>{st}</option>)}</Sel></Fld>
        <Fld label="Quantity"><Inp type="number" value={f.qty} onChange={s("qty")}/></Fld>
        <Fld label="Unit"><Sel value={f.unit} onChange={s("unit")}>{["units","pcs","boxes","bottles","sets","racks","rolls","kg","L","m"].map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <Fld label="Min Stock Alert"><Inp type="number" value={f.minQty} onChange={s("minQty")}/></Fld>
        <Fld label="Location"><Inp value={f.loc} onChange={s("loc")}/></Fld>
        <Fld label="Label ID" hint="ID on physical sticker"><Inp value={f.displayId} onChange={s("displayId")}/></Fld>
        <div style={{gridColumn:"1/-1"}}><Fld label="Serial Number"><Inp placeholder="e.g. SN-2024-001" value={f.serial} onChange={s("serial")}/></Fld></div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Description"><Inp value={f.desc} onChange={s("desc")}/></Fld></div>
        <div style={{gridColumn:"1/-1",display:"flex",gap:20,flexWrap:"wrap",padding:"4px 0"}}>{CHKBOX("Shared â€” multiple users simultaneously","shared")}{CHKBOX("Consumable â€” deduct qty, no checkout needed","consumable")}</div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Image"><ImageUpload value={f.img} onChange={v=>setF(p=>({...p,img:v}))}/></Fld></div>
      </div>
      <div style={{borderTop:"1px solid var(--border)",marginTop:4,paddingTop:16,display:"flex",gap:10,justifyContent:"space-between"}}>
        <div>
          {isAdmin && (!confirmDel ? (
            <Btn v="danger" onClick={()=>setConfirmDel(true)}><Ico n="trash" s={14} col="var(--red)"/>Delete Item</Btn>
          ) : (
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              <span style={{color:"var(--red)",fontSize:12}}>Are you sure?</span>
              <Btn v="danger" sm onClick={()=>{onDelete(item.id);onClose();}}>Yes, delete</Btn>
              <Btn v="ghost" sm onClick={()=>setConfirmDel(false)}>Cancel</Btn>
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:10}}>
          <Btn v="ghost" onClick={onClose}>Cancel</Btn>
          <Btn onClick={()=>{if(f.name&&f.qty){onSave({...item,...f,qty:+f.qty,minQty:+f.minQty||1,shared:f.shared,consumable:f.consumable,displayId:f.displayId});onClose();}}} disabled={!f.name||!f.qty}><Ico n="check" s={14} col="#000"/>Save Changes</Btn>
        </div>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ PENDING ITEM STAGING MODAL (delivery â†’ inventory) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PendingItemModal = ({order,allItems,categories,onClose,onConfirm}) => {
  const [f,setF]=useState({name:order.item||"",cat:order.cat||categories[0]||"Other",qty:String(order.qty||""),unit:order.unit||"units",loc:"",desc:"",minQty:"1",serial:"",shared:false,consumable:false,img:""});
  const [displayId,setDisplayId]=useState(()=>genDisplayId(order.cat||categories[0]||"Other",allItems));
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  const chk=k=>e=>setF(p=>({...p,[k]:e.target.checked}));
  const onCatChange=e=>{setF(p=>({...p,cat:e.target.value}));setDisplayId(genDisplayId(e.target.value,allItems));};
  return(
    <Modal onClose={onClose} title="ðŸ“¦ Add Received Item to Inventory" mw={560}>
      <p style={{color:"var(--sub)",fontSize:13,marginBottom:14}}>Order received! Fill in the missing details before it goes into inventory.</p>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div style={{gridColumn:"1/-1"}}><Fld label="Item Name"><Inp value={f.name} onChange={s("name")}/></Fld></div>
        <Fld label="Category"><Sel value={f.cat} onChange={onCatChange}>{categories.map(c=><option key={c}>{c}</option>)}</Sel></Fld>
        <Fld label="Label ID" hint="Print on physical sticker"><Inp value={displayId} onChange={e=>setDisplayId(e.target.value)}/></Fld>
        <Fld label="Quantity"><Inp type="number" value={f.qty} onChange={s("qty")}/></Fld>
        <Fld label="Unit"><Sel value={f.unit} onChange={s("unit")}>{["units","pcs","boxes","bottles","sets","rolls","kg","L","m"].map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <Fld label="Min Stock Alert"><Inp type="number" value={f.minQty} onChange={s("minQty")}/></Fld>
        <div style={{gridColumn:"1/-1"}}><Fld label="Location" hint="Required â€” where will this live?"><Inp placeholder="e.g. Room 3A / Shelf C1" value={f.loc} onChange={s("loc")}/></Fld></div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Serial Number (optional)"><Inp value={f.serial} onChange={s("serial")}/></Fld></div>
        <div style={{gridColumn:"1/-1"}}><Fld label="Notes"><Inp value={f.desc} onChange={s("desc")}/></Fld></div>
        <div style={{gridColumn:"1/-1",display:"flex",gap:20,flexWrap:"wrap",padding:"4px 0"}}>
          <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"var(--sub)"}}><input type="checkbox" checked={f.shared} onChange={chk("shared")} style={{accentColor:"var(--cyan)"}}/>Shared resource</label>
          <label style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"var(--sub)"}}><input type="checkbox" checked={f.consumable} onChange={chk("consumable")} style={{accentColor:"var(--cyan)"}}/>Consumable</label>
        </div>
      </div>
      <div style={{borderTop:"1px solid var(--border)",marginTop:16,paddingTop:16,display:"flex",gap:10,justifyContent:"flex-end"}}>
        <Btn v="ghost" onClick={onClose}>Skip (add later)</Btn>
        <Btn onClick={()=>{if(f.name){onConfirm({...f,displayId});onClose();}}} disabled={!f.name}><Ico n="plus" s={14} col="#000"/>Add to Inventory</Btn>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ ORDER REQUEST MODAL (multi-item) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OrderModal = ({onClose,onAddMany,userName="",categories}) => {
  const UNITS = ["units","pcs","boxes","bottles","sets","rolls","kg","L","m"];
  const [store,setStore]       = useState("");
  const [urgency,setUrgency]   = useState("Normal");
  const [dateNeeded,setDate]   = useState(getToday());
  const [reason,setReason]     = useState("");
  const [items,setItems]       = useState([{name:"",qty:"",unit:"units",cat:categories[0]||"Other",price:"",link:""}]);

  const addItem = () => setItems(p=>[...p,{name:"",qty:"",unit:"units",cat:categories[0]||"Other",price:"",link:""}]);
  const removeItem = i => setItems(p=>p.filter((_,j)=>j!==i));
  const upd = (i,field,val) => setItems(p=>p.map((it,j)=>j===i?{...it,[field]:val}:it));

  const validItems = items.filter(it=>it.name.trim()&&it.qty&&it.link.trim());
  const canSubmit  = store.trim() && validItems.length>0;

  const submit = () => {
    if(!canSubmit) return;
    const ts = Date.now();
    onAddMany(validItems.map((it,i)=>({
      id: ts+i, item:it.name.trim(), qty:+it.qty, unit:it.unit, cat:it.cat, price:it.price,
      store:store.trim(), link:it.link.trim(), urgency, date:dateNeeded, reason:reason.trim(),
      requestedBy:userName, status:"Pending"
    })));
    onClose();
  };

  const urgColors={Urgent:"var(--red)",High:"var(--amber)",Normal:"var(--blue)",Low:"var(--sub)"};

  return(
    <Modal onClose={onClose} title="ðŸ›’ Request Order" mw={680}>
      {/* â”€â”€ Store + Link (required) â”€â”€ */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:10,padding:"14px 16px",marginBottom:14}}>
        <div style={{color:"var(--sub)",fontSize:11,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace",marginBottom:10}}>Store Info</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          <Fld label="Store / Supplier *" hint="e.g. Amazon, McMaster, DigiKey">
            <Inp placeholder="Amazon, McMaster, DigiKeyâ€¦" value={store} onChange={e=>setStore(e.target.value)}
              style={{borderColor:store.trim()?"var(--border)":"var(--amber)"}}/>
          </Fld>
          <Fld label="Urgency">
            <Sel value={urgency} onChange={e=>setUrgency(e.target.value)}>
              {["Low","Normal","High","Urgent"].map(u=><option key={u}>{u}</option>)}
            </Sel>
          </Fld>
          <Fld label="Date Needed By"><Inp type="date" value={dateNeeded} onChange={e=>setDate(e.target.value)}/></Fld>
          <div style={{gridColumn:"1/-1"}}>
            <Fld label="Reason / Notes"><Inp placeholder="Why do we need this? Which project/experiment?" value={reason} onChange={e=>setReason(e.target.value)}/></Fld>
          </div>
        </div>
      </div>

      {/* â”€â”€ Item List â”€â”€ */}
      <div style={{marginBottom:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <span style={{color:"var(--sub)",fontSize:11,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>
            Items * <span style={{color:"var(--dim)",fontWeight:400,textTransform:"none",letterSpacing:0}}>({validItems.length} valid)</span>
          </span>
          <Btn sm v="ghost" onClick={addItem}><Ico n="plus" s={12}/>Add Item</Btn>
        </div>
        {items.map((it,i)=>(
          <div key={i} style={{background:"var(--bg2)",border:`1px solid ${it.name.trim()&&it.qty?"var(--border)":"var(--border)"}`,borderRadius:10,padding:"10px 12px",marginBottom:8,animation:"fadeIn .2s ease"}}>
            <div style={{display:"flex",gap:8,alignItems:"center",marginBottom:8}}>
              <div style={{flex:3,minWidth:0}}>
                <Inp placeholder={`Item name / part # ${i===0?"(required)":"(optional)"}`} value={it.name} onChange={e=>upd(i,"name",e.target.value)}/>
              </div>
              <div style={{width:72}}>
                <Inp type="number" placeholder="Qty" value={it.qty} onChange={e=>upd(i,"qty",e.target.value)} style={{textAlign:"center"}}/>
              </div>
              <div style={{width:88}}>
                <Sel value={it.unit} onChange={e=>upd(i,"unit",e.target.value)} style={{padding:"9px 6px",fontSize:12}}>
                  {UNITS.map(u=><option key={u}>{u}</option>)}
                </Sel>
              </div>
              {items.length>1&&(
                <button onClick={()=>removeItem(i)} style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:4,display:"flex",flexShrink:0}}><Ico n="x" s={14}/></button>
              )}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 2fr",gap:8}}>
              <Sel value={it.cat} onChange={e=>upd(i,"cat",e.target.value)} style={{padding:"7px 8px",fontSize:12}}>
                {categories.map(c=><option key={c}>{c}</option>)}
              </Sel>
              <Inp placeholder="Est. price" value={it.price} onChange={e=>upd(i,"price",e.target.value)}/>
              <Inp placeholder="Purchase link (required) https://â€¦" value={it.link} onChange={e=>upd(i,"link",e.target.value)}
                style={{borderColor:it.link.trim()?"var(--border)":"var(--amber)"}}/>
            </div>
          </div>
        ))}
      </div>

      <div style={{borderTop:"1px solid var(--border)",paddingTop:14,display:"flex",gap:10,justifyContent:"space-between",alignItems:"center"}}>
        <div style={{display:"flex",gap:6,alignItems:"center"}}>
          <span style={{background:urgColors[urgency]+"22",color:urgColors[urgency],border:`1px solid ${urgColors[urgency]}44`,borderRadius:20,padding:"2px 9px",fontSize:10,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace"}}>{urgency}</span>
          <span style={{color:"var(--dim)",fontSize:12}}>{validItems.length} item{validItems.length!==1?"s":""} Â· {store||"no store yet"}</span>
        </div>
        <div style={{display:"flex",gap:10}}>
          <Btn v="ghost" onClick={onClose}>Cancel</Btn>
          <Btn onClick={submit} disabled={!canSubmit}><Ico n="cart" s={14} col="#000"/>Submit {validItems.length>1?`${validItems.length} Requests`:"Request"}</Btn>
        </div>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ CONFIRM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ConfirmModal = ({msg,onConfirm,onClose}) => (
  <Modal onClose={onClose} title="Confirm Action" mw={400}>
    <p style={{color:"var(--sub)",fontSize:14,lineHeight:1.6,marginBottom:20}}>{msg}</p>
    <div style={{display:"flex",gap:10,justifyContent:"flex-end"}}>
      <Btn v="ghost" onClick={onClose}>Cancel</Btn>
      <Btn v="danger" onClick={()=>{onConfirm();onClose();}}>Confirm</Btn>
    </div>
  </Modal>
);

// â”€â”€â”€ ITEM DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ItemDetail = ({item,checkouts,onClose,onReturn,onQuickCheckout,onEdit,categories}) => {
  const [confirmId,setConfirmId]=useState(null);
  const hist=checkouts.filter(c=>c.item===item.name);
  const ac=getCatAccent(item.cat,categories);
  const isLow=item.qty<=item.minQty;
  return(
    <>
    <Modal onClose={onClose} title="" mw={640}>
      <div style={{display:"flex",gap:20,marginBottom:22,flexWrap:"wrap"}}>
        <div style={{position:"relative",flexShrink:0}}>
          <img src={item.img||`https://placehold.co/200x148/141b24/3d5068?text=${encodeURIComponent(item.cat)}`} alt={item.name} style={{width:200,height:148,objectFit:"cover",borderRadius:12,border:"1px solid var(--border)",display:"block"}}/>
        </div>
        <div style={{flex:1,minWidth:200}}>
          <h3 style={{margin:"0 0 8px",fontSize:19,fontFamily:"'Roboto',sans-serif",fontWeight:800}}>{item.name}</h3>
          <div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap"}}>
            <Badge status={isLow?"Low Stock":item.status}/>
            <span style={{background:"var(--bg3)",color:ac,border:`1px solid ${ac}30`,borderRadius:20,padding:"2px 9px",fontSize:10,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{item.cat}</span>
          </div>
          <p style={{color:"var(--sub)",fontSize:13,lineHeight:1.6,margin:"0 0 14px"}}>{item.desc||"No description."}</p>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>
            {[["Location",item.loc||"â€”"],["Stock",`${item.qty} ${item.unit}`],["Min Stock",`${item.minQty} ${item.unit}`],["Serial",item.serial||"â€”"]].map(([k,v])=>(
              <div key={k}>
                <div style={{color:"var(--dim)",fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.1em",fontFamily:"'IBM Plex Mono',monospace"}}>{k}</div>
                <div style={{color:"var(--text)",fontSize:13}}>{v}</div>
              </div>
            ))}
          </div>
          <div style={{display:"flex",gap:8}}>
            {item.status!=="Maintenance"&&<Btn onClick={()=>{onClose();onQuickCheckout(item.name);}}><Ico n="tag" s={14} col="#000"/>Quick Check Out</Btn>}
            <Btn v="ghost" onClick={()=>{onClose();onEdit(item);}}><Ico n="edit" s={14}/>Edit</Btn>
          </div>
        </div>
      </div>
      {item.usedBy?.length>0&&(
        <div style={{marginBottom:18}}>
          <div style={{color:"var(--dim)",fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.1em",fontFamily:"'IBM Plex Mono',monospace",marginBottom:8}}>Currently Using</div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            {item.usedBy.map(u=>(
              <div key={u} style={{display:"flex",alignItems:"center",gap:8,background:"var(--blue-d)",border:"1px solid #4da6ff22",borderRadius:8,padding:"6px 12px"}}>
                <MemberAvatar name={u} sz={24}/><span style={{fontSize:13,color:"var(--blue)"}}>{u}</span>
              </div>
            ))}
          </div>
        </div>
      )}
      {hist.length>0&&(
        <div>
          <div style={{color:"var(--dim)",fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.1em",fontFamily:"'IBM Plex Mono',monospace",marginBottom:8}}>Checkout History</div>
          {hist.map(c=>{
            const od=isOverdue(c);
            return(
              <div key={c.id} style={{display:"flex",alignItems:"center",gap:10,background:od?"var(--red-d)":"var(--bg2)",border:`1px solid ${od?"#ff4d6a30":"var(--border)"}`,borderRadius:8,padding:"8px 12px",marginBottom:6,flexWrap:"wrap"}}>
                <MemberAvatar name={c.user} sz={26}/>
                <span style={{color:"var(--text)",fontSize:13,flex:1}}>{c.user}</span>
                <span style={{color:od?"var(--red)":"var(--dim)",fontSize:10,fontFamily:"'IBM Plex Mono',monospace"}}>{c.out} â†’ {c.ret||"â€”"}{od&&" OVERDUE"}</span>
                <Badge status={od?"Overdue":c.status}/>
                {c.status==="Active"&&<Btn v="ghost" sm onClick={()=>setConfirmId(c.id)}><Ico n="undo" s={12}/>Return</Btn>}
              </div>
            );
          })}
        </div>
      )}
    </Modal>
    {confirmId&&<ConfirmModal msg="Mark this item as returned?" onConfirm={()=>{onReturn(confirmId);onClose();}} onClose={()=>setConfirmId(null)}/>}
    </>
  );
};

// â”€â”€â”€ STAT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Stat=({label,val,icon,ac,sub,warn})=>(
  <div style={{background:"var(--bg1)",border:`1px solid ${warn?"#ff4d6a30":"var(--border)"}`,borderLeft:`3px solid ${ac}`,borderRadius:14,padding:"17px 20px",flex:1,minWidth:130}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
      <div>
        <div style={{color:"var(--dim)",fontSize:10,fontWeight:700,letterSpacing:"0.12em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace",marginBottom:5}}>{label}</div>
        <div style={{color:ac,fontFamily:"'Roboto',sans-serif",fontSize:34,fontWeight:900,lineHeight:1,letterSpacing:"-0.02em",textShadow:`0 0 24px ${ac}33`}}>{val}</div>
        {sub&&<div style={{color:"var(--dim)",fontSize:11,marginTop:3}}>{sub}</div>}
      </div>
      <Ico n={icon} s={20} col={ac}/>
    </div>
  </div>
);

// â”€â”€â”€ PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Pagination = ({total, page, setPage}) => {
  const totalPages = Math.ceil(total / ITEMS_PER_PAGE);
  if (totalPages <= 1) return null;
  const start = page * ITEMS_PER_PAGE + 1;
  const end = Math.min((page+1) * ITEMS_PER_PAGE, total);
  const pages = [];
  for (let i = 0; i < totalPages; i++) {
    if (i === 0 || i === totalPages-1 || Math.abs(i - page) <= 1) pages.push(i);
    else if (pages[pages.length-1] !== "...") pages.push("...");
  }
  return (
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:20,flexWrap:"wrap",gap:10}}>
      <span style={{color:"var(--dim)",fontSize:12}}>Showing {start}â€“{end} of {total} items</span>
      <div style={{display:"flex",gap:4,alignItems:"center"}}>
        <button onClick={()=>setPage(Math.max(0,page-1))} disabled={page===0} style={{background:"var(--bg3)",border:"1px solid var(--border)",color:page===0?"var(--dim)":"var(--text)",borderRadius:6,padding:"5px 10px",cursor:page===0?"default":"pointer",fontSize:13}}>
          <Ico n="chevL" s={14}/>
        </button>
        {pages.map((p,i)=>p==="..." ? (
          <span key={`d${i}`} style={{color:"var(--dim)",padding:"0 4px"}}>...</span>
        ) : (
          <button key={p} onClick={()=>setPage(p)} style={{background:p===page?"var(--cyan)":"var(--bg3)",color:p===page?"#000":"var(--sub)",border:`1px solid ${p===page?"var(--cyan)":"var(--border)"}`,borderRadius:6,padding:"5px 10px",cursor:"pointer",fontSize:12,fontWeight:p===page?700:400,minWidth:32}}>{p+1}</button>
        ))}
        <button onClick={()=>setPage(Math.min(totalPages-1,page+1))} disabled={page===totalPages-1} style={{background:"var(--bg3)",border:"1px solid var(--border)",color:page===totalPages-1?"var(--dim)":"var(--text)",borderRadius:6,padding:"5px 10px",cursor:page===totalPages-1?"default":"pointer",fontSize:13}}>
          <Ico n="chevR" s={14}/>
        </button>
      </div>
    </div>
  );
};

// â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CalView=({checkouts,deliveries})=>{
  const now = new Date();
  const [yr,setYr]=useState(now.getFullYear());
  const [mo,setMo]=useState(now.getMonth());
  const MNS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const first=new Date(yr,mo,1).getDay(), total=new Date(yr,mo+1,0).getDate();
  const prev=()=>mo===0?(setMo(11),setYr(y=>y-1)):setMo(m=>m-1);
  const next=()=>mo===11?(setMo(0),setYr(y=>y+1)):setMo(m=>m+1);
  const evts=d=>{
    const ds=`${yr}-${String(mo+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const r=[];
    deliveries.forEach(x=>x.date===ds&&r.push({t:"pkg",l:x.item}));
    checkouts.forEach(x=>{if(x.out===ds)r.push({t:"out",l:x.item});if(x.ret===ds)r.push({t:isOverdue(x)?"odd":"ret",l:x.item});});
    return r;
  };
  const EC={pkg:{bg:"var(--green-d)",col:"var(--green)"},out:{bg:"var(--blue-d)",col:"var(--blue)"},ret:{bg:"var(--amber-d)",col:"var(--amber)"},odd:{bg:"var(--red-d)",col:"var(--red)"}};
  const EC_LABELS={pkg:"Pkg",out:"Out",ret:"Ret",odd:"Due!"};
  const td=getTodayParts();
  return(
    <div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <button onClick={prev} style={{background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"6px 14px",cursor:"pointer",fontSize:14}}>â†</button>
        <span style={{fontFamily:"'Roboto',sans-serif",fontWeight:700,fontSize:19}}>{MNS[mo]} {yr}</span>
        <button onClick={next} style={{background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"6px 14px",cursor:"pointer",fontSize:14}}>â†’</button>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3,marginBottom:4}}>
        {["Su","Mo","Tu","We","Th","Fr","Sa"].map(d=><div key={d} style={{textAlign:"center",color:"var(--dim)",fontSize:10,fontWeight:700,padding:"4px 0",fontFamily:"'IBM Plex Mono',monospace"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3}}>
        {Array.from({length:first}).map((_,i)=><div key={`e${i}`}/>)}
        {Array.from({length:total}).map((_,i)=>{
          const d=i+1,isT=d===td.d&&mo===td.m&&yr===td.y,ev=evts(d);
          return(
            <div key={d} style={{background:isT?"var(--blue-d)":"var(--bg2)",borderRadius:8,minHeight:68,border:`1px solid ${isT?"var(--blue)":"var(--border)"}`,padding:"5px 6px"}}>
              <div style={{color:isT?"var(--blue)":"var(--dim)",fontSize:10,fontWeight:isT?800:500,fontFamily:"'IBM Plex Mono',monospace",marginBottom:3}}>{d}</div>
              {ev.slice(0,2).map((e,j)=>{const ec=EC[e.t];return<div key={j} style={{background:ec.bg,color:ec.col,fontSize:8,borderRadius:4,padding:"2px 4px",marginBottom:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:1.4}}>{EC_LABELS[e.t]} {e.l}</div>;})}
              {ev.length>2&&<div style={{color:"var(--dim)",fontSize:8}}>+{ev.length-2}</div>}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",gap:20,marginTop:14,flexWrap:"wrap"}}>
        {[["var(--green)","Delivery"],["var(--blue)","Checkout"],["var(--amber)","Return Due"],["var(--red)","Overdue"]].map(([col,lbl])=>(
          <div key={lbl} style={{display:"flex",alignItems:"center",gap:5,fontSize:12}}>
            <span style={{width:10,height:10,borderRadius:3,background:col,display:"inline-block"}}/>
            <span style={{color:col}}>{lbl}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

// â”€â”€â”€ LOGIN PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LoginPage = ({onSignIn}) => {
  const btnRef = useRef(null);
  const [error, setError] = useState("");
  const [gsiReady, setGsiReady] = useState(false);
  useEffect(()=>{
    const init = () => {
      if (typeof google === 'undefined' || !google.accounts) { setTimeout(init, 200); return; }
      try {
        google.accounts.id.initialize({
          client_id: APP_CONFIG.oauth_client_id,
          callback: (response) => {
            try {
              const payload = JSON.parse(atob(response.credential.split('.')[1]));
              if (payload.hd !== "seas.upenn.edu") { setError("Access restricted to @seas.upenn.edu accounts only."); return; }
              onSignIn({ token: response.credential, name: payload.name, email: payload.email, picture: payload.picture });
            } catch(e) { setError("Failed to verify account. Please try again."); }
          },
          hd: "seas.upenn.edu",
          auto_select: true,
        });
        google.accounts.id.renderButton(btnRef.current, { type: "standard", theme: "filled_black", size: "large", text: "signin_with", shape: "pill", width: 300 });
        setGsiReady(true);
      } catch(e) { console.error("GSI init error:", e); }
    };
    init();
  }, []);
  return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"var(--bg0)"}}>
      <div style={{textAlign:"center",animation:"fadeUp .5s ease",maxWidth:420,padding:"0 24px"}}>
        <div style={{width:72,height:72,borderRadius:18,background:"linear-gradient(135deg,#00d4c8,#004d4a)",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 0 40px rgba(0,212,200,.25)",margin:"0 auto 24px"}}>
          <Ico n="layers" s={32} col="var(--bg0)"/>
        </div>
        <h1 style={{fontFamily:"'Roboto',sans-serif",fontWeight:900,fontSize:32,margin:"0 0 6px",letterSpacing:"-0.03em"}}>LabTrack</h1>
        <p style={{color:"var(--sub)",fontSize:15,margin:"0 0 8px",lineHeight:1.5}}>Figueroa Lab Inventory</p>
        <p style={{color:"var(--dim)",fontSize:13,margin:"0 0 32px"}}>Penn Engineering</p>
        <div>
          <div ref={btnRef} style={{display:"flex",justifyContent:"center",marginBottom:16}}/>
          {!gsiReady && <p style={{color:"var(--dim)",fontSize:12}}>Loading sign-in...</p>}
          <p style={{color:"var(--dim)",fontSize:12}}>Sign in with your @seas.upenn.edu account</p>
          {error && <p style={{color:"var(--red)",fontSize:13,marginTop:12,background:"var(--red-d)",padding:"8px 14px",borderRadius:8,border:"1px solid #ff4d6a30"}}>{error}</p>}
        </div>
      </div>
    </div>
  );
};

// â”€â”€â”€ EDIT ORDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EditOrderModal = ({order,onClose,onSave,isAdmin,categories}) => {
  const UNITS=["units","pcs","boxes","bottles","sets","rolls","kg","L","m"];
  const STATUSES=["Pending","Approved","Ordered","Received","Rejected"];
  const [f,setF]=useState({...order});
  const s=k=>e=>setF(p=>({...p,[k]:e.target.value}));
  return(
    <Modal onClose={onClose} title="âœï¸ Edit Order Request" mw={640}>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <Fld label="Store / Supplier *"><Inp value={f.store||""} onChange={s("store")}/></Fld>
        <Fld label="Urgency"><Sel value={f.urgency} onChange={s("urgency")}>{["Low","Normal","High","Urgent"].map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <div style={{gridColumn:"1/-1"}}><Fld label="Item Name *"><Inp value={f.item||""} onChange={s("item")}/></Fld></div>
        <Fld label="Qty"><Inp type="number" value={f.qty} onChange={s("qty")}/></Fld>
        <Fld label="Unit"><Sel value={f.unit} onChange={s("unit")}>{UNITS.map(u=><option key={u}>{u}</option>)}</Sel></Fld>
        <Fld label="Category"><Sel value={f.cat||categories[0]} onChange={s("cat")}>{categories.map(c=><option key={c}>{c}</option>)}</Sel></Fld>
        <Fld label="Est. Price"><Inp value={f.price||""} onChange={s("price")}/></Fld>
        <div style={{gridColumn:"1/-1"}}><Fld label="Purchase Link *"><Inp value={f.link||""} onChange={s("link")}/></Fld></div>
        <Fld label="Date Needed By"><Inp type="date" value={f.date||""} onChange={s("date")}/></Fld>
        {isAdmin&&<Fld label="Status (Admin only)"><Sel value={f.status} onChange={s("status")}>{STATUSES.map(st=><option key={st}>{st}</option>)}</Sel></Fld>}
        <div style={{gridColumn:"1/-1"}}><Fld label="Reason / Notes"><Inp value={f.reason||""} onChange={s("reason")}/></Fld></div>
      </div>
      <div style={{borderTop:"1px solid var(--border)",paddingTop:14,marginTop:4,display:"flex",gap:10,justifyContent:"flex-end"}}>
        <Btn v="ghost" onClick={onClose}>Cancel</Btn>
        <Btn onClick={()=>{onSave({...f,qty:+f.qty});onClose();}} disabled={!(f.store||"").trim()||(!(f.item||"").trim())||(!(f.link||"").trim())}>
          <Ico n="check" s={14} col="#000"/>Save Changes
        </Btn>
      </div>
    </Modal>
  );
};

// â”€â”€â”€ PHYSICAL LABEL ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function catPrefix(cat) {
  // Use stored custom prefix if available
  try { const m=JSON.parse(localStorage.getItem("labtrack_catprefixes")||"{}"); if(m[cat]) return m[cat]; } catch {}
  // Auto: initials of each word, e.g. "Robots & Motors"â†’"RM", "Other"â†’"OTHE"
  const words=(cat||"GEN").split(/[\s&\/\-_]+/).filter(Boolean);
  return (words.length===1 ? words[0].slice(0,4) : words.map(w=>w[0]).join("")).toUpperCase()||"GEN";
}
function genDisplayId(cat, allItems) {
  const prefix = catPrefix(cat);
  // Global sequential counter (5 digits, up to 99,999 items)
  const maxNum = Math.max(0,...(allItems||[]).map(i=>{const m=String(i.displayId||"").match(/(\d+)$/);return m?parseInt(m[1]):0;}));
  return `${prefix}-${String(maxNum+1).padStart(5,"0")}`;
}

// â”€â”€â”€ EMAIL TEXT GENERATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateEmailText(orders) {
  const dateStr = new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
  const fmtP = p => {
    if(!p && p!==0) return "â€”";
    const n = typeof p==="number" ? p : parseFloat(String(p).replace(/[^0-9.]/g,""));
    return isNaN(n) ? String(p) : "$"+n.toFixed(2);
  };
  const calcTotal = (price,qty) => {
    const p = typeof price==="number" ? price : parseFloat(String(price||"").replace(/[^0-9.]/g,""));
    const q = parseFloat(qty)||0;
    return (!isNaN(p)&&q) ? p*q : null;
  };
  const cols = ["Store","Item","Purchase Link","Qty","Unit Price","Total"];
  const rows = orders.map(o=>{
    const tot=calcTotal(o.price,o.qty);
    return [String(o.store||"â€”"),String(o.item||"â€”"),String(o.link||"(no link)"),
      `${o.qty||""} ${o.unit||""}`.trim()||"â€”",fmtP(o.price),tot!==null?"$"+tot.toFixed(2):"â€”"];
  });
  const grand = orders.reduce((a,o)=>{const t=calcTotal(o.price,o.qty);return t!==null?a+t:a;},0);
  const widths = cols.map((c,i)=>Math.max(c.length,...rows.map(r=>r[i].length))+2);
  const pad=(s,w)=>s.padEnd(w);
  const sep=widths.map(w=>"-".repeat(w)).join("+");
  const header=widths.map((w,i)=>pad(cols[i],w)).join("|");
  const dataRows=rows.map(r=>widths.map((w,i)=>pad(r[i],w)).join("|")).join("\n");
  const footer=grand>0?`\n\nGrand Total: $${grand.toFixed(2)}`:"";
  return `Purchase Request â€” ${dateStr}\n\n${header}\n${sep}\n${dataRows}${footer}`;
}


// â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LabInventory(){
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [fetchingData, setFetchingData] = useState(false);

  const [tab,setTab] = useState("inventory");
  const [items,setItems] = useState([]);
  const [deliveries,setDeliv] = useState([]);
  const [checkouts,setCheckouts] = useState([]);
  const [orders,setOrders] = useState([]);
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
  const [modal,setModal] = useState(null);
  const [preItem,setPreItem] = useState("");
  const [detail,setDetail] = useState(null);
  const [editItem,setEditItem] = useState(null);
  const [pendingItem,setPendingItem] = useState(null);
  const [search,setSearch] = useState("");
  const [catF,setCatF] = useState("All");
  const [view,setView] = useState("grid");
  const [selected,setSelected] = useState(new Set());
  const [toasts,setToasts] = useState([]);
  const [confirm,setConfirm] = useState(null);
  const [dataLoaded,setDataLoaded] = useState(false);
  const [userRole, setUserRole] = useState("member");
  const [page, setPage] = useState(0);
  const [sortBy, setSortBy] = useState("name-az");
  const [darkMode, setDarkMode] = useState(true);
  const tid = useRef(0);
  const refreshTimer = useRef(null);
  const deletedItemIds = useRef(new Set());
  const lastModified = useRef({items:0, orders:0, checkouts:0, deliveries:0});
  const [selectedOrders, setSelectedOrders] = useState(new Set());
  const [editOrder, setEditOrder] = useState(null);
  const [emailText, setEmailText] = useState("");
  const [sessionExpired, setSessionExpired] = useState(false);

  // Restore session + theme
  useEffect(()=>{
    try {
      const saved = localStorage.getItem("labtrack_user");
      if (saved) setUser(JSON.parse(saved));
      const savedCats = localStorage.getItem("labtrack_categories");
      if (savedCats) setCategories(JSON.parse(savedCats));
      const dark = localStorage.getItem("labtrack_dark");
      if (dark !== null) {
        const isDark = dark !== "false";
        setDarkMode(isDark);
        document.documentElement.classList.toggle("light", !isDark);
      }
    } catch {}
    setLoading(false);
  },[]);

  // Apply dark/light mode
  useEffect(()=>{
    document.documentElement.classList.toggle("light", !darkMode);
    localStorage.setItem("labtrack_dark", String(darkMode));
  },[darkMode]);

  // Fetch data from backend when signed in
  useEffect(()=>{
    if (!user || dataLoaded) return;
    if (!APP_CONFIG.apps_script_url || user.token === "local") {
      try {
        const saved = localStorage.getItem("labtrack_data");
        if (saved) {
          const d = JSON.parse(saved);
          if (d.items) setItems(d.items);
          if (d.deliveries) setDeliv(d.deliveries);
          if (d.checkouts) setCheckouts(d.checkouts);
          if (d.orders) setOrders(d.orders);
        }
      } catch {}
      setDataLoaded(true);
      return;
    }
    setFetchingData(true);
    (async ()=>{
      const data = await API.fetchAll(user.token);
      if (data && data.error) {
        console.error("[LabTrack] Backend error:", data.error, data.detail);
        try {
          const saved = localStorage.getItem("labtrack_data");
          if (saved) {
            const d = JSON.parse(saved);
            if (d.items) setItems(d.items);
            if (d.deliveries) setDeliv(d.deliveries);
            if (d.checkouts) setCheckouts(d.checkouts);
            if (d.orders) setOrders(d.orders);
          }
        } catch {}
      } else if (data && data.items) {
        setItems(data.items);
        setDeliv(data.deliveries || []);
        setCheckouts(data.checkouts || []);
        setOrders(data.orders || []);
        // Load categories from settings
        if (data.settings && data.settings.categories) {
          try {
            const serverCats = JSON.parse(data.settings.categories);
            if (Array.isArray(serverCats) && serverCats.length > 0) {
              setCategories(serverCats);
              localStorage.setItem("labtrack_categories", JSON.stringify(serverCats));
            }
          } catch {}
        }
        if (data.userRole) setUserRole(data.userRole);
      }
      setDataLoaded(true);
      setFetchingData(false);
    })();
  },[user]);

  // Save data locally as fallback
  useEffect(()=>{
    if (!dataLoaded) return;
    localStorage.setItem("labtrack_data", JSON.stringify({items, deliveries, checkouts, orders}));
  },[items, deliveries, checkouts, orders, dataLoaded]);

  // Auto-refresh: poll every 30s for changes from other users
  useEffect(()=>{
    if (!user || !dataLoaded || !APP_CONFIG.apps_script_url || user.token === "local") return;
    const interval = setInterval(async ()=>{
      try {
        const data = await API.fetchAll(user.token);
        if (data && !data.error && data.items) {
          const now = Date.now(); const GRACE = 60000;
          const lm = lastModified.current;
          if (now - lm.items     > GRACE) setItems(data.items.filter(i=>!deletedItemIds.current.has(String(i.id))));
          if (now - lm.deliveries > GRACE) setDeliv(data.deliveries || []);
          if (now - lm.checkouts  > GRACE) setCheckouts(data.checkouts || []);
          if (now - lm.orders     > GRACE) setOrders(data.orders || []);
          if (data.userRole) setUserRole(data.userRole);
          if (data.settings && data.settings.categories) {
            try {
              const sc = JSON.parse(data.settings.categories);
              if (Array.isArray(sc) && sc.length > 0) { setCategories(sc); localStorage.setItem("labtrack_categories", JSON.stringify(sc)); }
            } catch {}
          }
        }
      } catch {}
    }, 30000);
    return () => clearInterval(interval);
  },[user, dataLoaded]);

  // Reset page when filters change
  useEffect(()=>{ setPage(0); },[search, catF]);

  const addToast=useCallback((type,msg,onClick)=>{
    const id=++tid.current;
    setToasts(t=>[...t,{id,type,msg,onClick}]);
    setTimeout(()=>setToasts(t=>t.filter(x=>x.id!==id)),6000);
    return id;
  },[]);

  const handleSignIn = (u) => {
    setUser(u); setSessionExpired(false); setDataLoaded(false);
    localStorage.setItem("labtrack_user", JSON.stringify(u));
    // Schedule silent token refresh 5 minutes before the JWT expires
    if (refreshTimer.current) clearTimeout(refreshTimer.current);
    try {
      const exp = JSON.parse(atob(u.token.split('.')[1])).exp;
      const msUntilRefresh = (exp * 1000) - Date.now() - 5 * 60 * 1000;
      if (msUntilRefresh > 0) {
        refreshTimer.current = setTimeout(()=>{ try { google.accounts.id.prompt(); } catch(e){} }, msUntilRefresh);
      }
    } catch(e) {}
  };
  const handleSignOut = () => { if (refreshTimer.current) clearTimeout(refreshTimer.current); setUser(null); setDataLoaded(false); setItems([]); setDeliv([]); setCheckouts([]); setOrders([]); localStorage.removeItem("labtrack_user"); try { google.accounts.id.disableAutoSelect(); } catch {} };

  const handleSaveCategories = async (newCats) => {
    setCategories(newCats);
    localStorage.setItem("labtrack_categories", JSON.stringify(newCats));
    if (APP_CONFIG.apps_script_url && user?.token !== "local") {
      await API.post(user.token, "saveSettings", { key: "categories", value: JSON.stringify(newCats) });
    }
    addToast("success", "Categories updated");
  };

  // keyboard shortcuts
  useEffect(()=>{
    if (!user) return;
    const h=e=>{
      if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.tagName==="SELECT")return;
      if(e.key==="Escape"){setModal(null);setDetail(null);setConfirm(null);}
      if(e.key==="n"||e.key==="N") setModal("delivery");
      if(e.key==="c"||e.key==="C"){setPreItem("");setModal("checkout");}
    };
    document.addEventListener("keydown",h);
    return()=>document.removeEventListener("keydown",h);
  },[user]);

  // computed
  const lowStock = items.filter(i=>i.qty<=i.minQty);
  const activeOut = checkouts.filter(c=>c.status==="Active");
  const overdues = checkouts.filter(c=>isOverdue(c));

  // handlers
  const postAction = async (action, payload) => {
    // Mark data type as locally modified â†’ suppress poll override for 60s
    const now = Date.now();
    if (/item/i.test(action)) lastModified.current.items = now;
    if (/checkout|return/i.test(action)) { lastModified.current.checkouts = now; lastModified.current.items = now; }
    if (/order/i.test(action)) lastModified.current.orders = now;
    if (/delivery/i.test(action)) lastModified.current.deliveries = now;
    if (APP_CONFIG.apps_script_url && user?.token !== "local") {
      const result = await API.post(user.token, action, payload);
      if (result && result.error === "Unauthorized") {
        setSessionExpired(true);
        try { google.accounts.id.prompt(); } catch(e) {}
      }
      if (result && result.error && result.error !== "Unauthorized") {
        addToast("error", `Error: ${result.error} â€” ${result.detail || ""}`);
      }
      return result;
    }
  };

  const handleDelivery=async(d)=>{
    setDeliv(p=>[d,...p]);
    addToast("success",`Delivery logged: ${d.item}`);
    await postAction("addDelivery", {delivery: d});
  };

  const handleCheckout=async(c)=>{
    const updated=items.map(i=>i.name===c.item?{...i,status:i.shared?"Available":"In Use",usedBy:[...(i.usedBy||[]),c.user]}:i);
    setItems(updated);
    setCheckouts(p=>[c,...p]);
    addToast("success",`${c.item} â†’ ${c.user}`);
    await postAction("addCheckout", {checkout: c});
  };

  const handleUseConsumable = async (itemId, qty) => {
    const item = items.find(i=>i.id===itemId); if(!item) return;
    const updated = {...item, qty: Math.max(0, item.qty - qty)};
    setItems(p=>p.map(i=>i.id===itemId?updated:i));
    addToast("success",`Used ${qty} ${item.unit} of ${item.name}`);
    await postAction("updateItem", {item: updated});
  };

  const handleReturn=async(coId)=>{
    const co=checkouts.find(c=>c.id===coId); if(!co)return;
    setCheckouts(p=>p.map(c=>c.id===coId?{...c,status:"Returned"}:c));
    setItems(p=>p.map(i=>i.name===co.item?{...i,status:"Available",usedBy:(i.usedBy||[]).filter(u=>u!==co.user)}:i));
    addToast("success",`${co.item} returned`);
    await postAction("returnItem", {checkoutId: coId});
  };

  const handleBulkReturn=async()=>{
    const ids=[...selected];
    for(const id of ids)await handleReturn(id);
    setSelected(new Set());
    addToast("success",`${ids.length} item${ids.length>1?"s":""} returned`);
  };

  const handleQuickCheckout=(itemName)=>{ setPreItem(itemName); setModal("checkout"); };

  const handleAddItem = async (item) => {
    setItems(p=>[item,...p]);
    addToast("success",`"${item.name}" added`);
    await postAction("addItem", {item});
  };

  const handleUpdateItem = async (updatedItem) => {
    setItems(p=>p.map(i=>i.id===updatedItem.id?{...i,...updatedItem}:i));
    addToast("success",`"${updatedItem.name}" updated`);
    await postAction("updateItem", {item: updatedItem});
  };

  const handleDeleteItem = async (itemId) => {
    if (userRole !== "admin") {
      addToast("error", "Only admins can delete items. Contact a lab admin.");
      return;
    }
    const deletedItem = items.find(i=>i.id===itemId);
    deletedItemIds.current.add(String(itemId));
    setItems(p=>p.filter(i=>i.id!==itemId));
    addToast("success","Item deleted");
    const result = await postAction("deleteItem", {itemId});
    if (result && result.error === "Forbidden") {
      deletedItemIds.current.delete(String(itemId));
      if (deletedItem) setItems(p=>[deletedItem,...p]);
      addToast("error", "Server rejected: " + (result.detail||"Not authorized"));
    }
  };

  const handleEditItem = (item) => { setEditItem(item); };

  const handleAddOrder = async (order) => {
    setOrders(p=>[order,...p]);
    addToast("success",`Order request submitted: ${order.item}`);
    await postAction("addOrder", {order});
  };

  const handleAddOrderMany = async (orders) => {
    setOrders(p=>[...orders,...p]);
    addToast("success",`${orders.length} order request${orders.length>1?"s":""} submitted`);
    for (const order of orders) {
      await postAction("addOrder", {order});
    }
  };

  const handleSendDigest = async () => {
    const tid2 = addToast("info", "Sending digest to Slackâ€¦");
    const result = await postAction("sendDigest", {});
    if (result && result.ok) addToast("success", "Slack digest sent! Check your channel.");
    else if (!result || result.error) addToast("error", "Digest failed â€” check webhook config.");
  };

  const handleUpdateOrderStatus = async (orderId, newStatus) => {
    setOrders(p=>p.map(o=>o.id===orderId?{...o,status:newStatus}:o));
    addToast("success",`Order marked as ${newStatus}`);
    await postAction("updateOrderStatus", {orderId, status: newStatus});
  };

  const handleUpdateOrder = async (order) => {
    setOrders(p=>p.map(o=>o.id===order.id?order:o));
    addToast("success","Order updated");
    await postAction("updateOrder", {order});
  };

  const handleDeleteOrder = async (orderId) => {
    if (userRole !== "admin") {
      addToast("error", "Only admins can delete orders.");
      return;
    }
    setOrders(p=>p.filter(o=>o.id!==orderId));
    addToast("success","Order request removed");
    await postAction("deleteOrder", {orderId});
  };

  // Show staging modal immediately; sync to sheet in background
  const handleOrderReceived = (order) => {
    setPendingItem(order); // instant â€” no waiting for API
    const delivery={id:Date.now(),item:order.item,qty:order.qty,unit:order.unit,from:"(Order #"+order.id+")",receivedBy:user?.name||"",date:getToday(),tracking:"",status:"Logged"};
    handleDelivery(delivery);              // fire and forget
    handleUpdateOrderStatus(order.id,"Received"); // fire and forget
  };

  const handleConfirmPendingItem = async (itemData) => {
    const newItem = {id:Date.now(), status:"Available", usedBy:[], ...itemData, qty:+itemData.qty||0, minQty:+itemData.minQty||1};
    setItems(p=>[newItem,...p]);
    addToast("success",`"${newItem.name}" added to inventory!`);
    await postAction("addItem", {item: newItem});
  };

  // filtered & sorted inventory
  const filtered = useMemo(()=>{
    let f = items.filter(i=>{
      const q=search.toLowerCase();
      return(i.name?.toLowerCase().includes(q)||i.loc?.toLowerCase().includes(q)||i.cat?.toLowerCase().includes(q)||i.desc?.toLowerCase().includes(q)||i.serial?.toLowerCase().includes(q))
        &&(catF==="All"||i.cat===catF);
    });
    // Sort
    if(sortBy==="name-az") f.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    else if(sortBy==="name-za") f.sort((a,b)=>(b.name||"").localeCompare(a.name||""));
    else if(sortBy==="newest") f.sort((a,b)=>Number(b.id)-Number(a.id));
    else if(sortBy==="qty-low") f.sort((a,b)=>a.qty-b.qty);
    else if(sortBy==="qty-high") f.sort((a,b)=>b.qty-a.qty);
    return f;
  },[items, search, catF, sortBy]);

  // Paginated
  const paginatedItems = filtered.slice(page * ITEMS_PER_PAGE, (page+1) * ITEMS_PER_PAGE);

  const pendingOrders = orders.filter(o=>o.status==="Pending").length;
  const activeOrders = orders.filter(o=>o.status!=="Received"&&o.status!=="Rejected").sort((a,b)=>Number(b.id)-Number(a.id));
  const receivedOrders = orders.filter(o=>o.status==="Received"||o.status==="Rejected").sort((a,b)=>Number(b.id)-Number(a.id));

  const TABS=[
    {id:"inventory",l:"Inventory",n:"grid",count:items.length},
    {id:"orders",l:"Order Requests",n:"cart",count:activeOrders.length},
    {id:"usage",l:"Usage",n:"users",count:activeOut.length},
    {id:"calendar",l:"Calendar",n:"calendar",count:0},
  ];

  // Loading
  if (loading) {
    return <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"var(--bg0)"}}>
      <div style={{textAlign:"center"}}>
        <div style={{width:40,height:40,border:"3px solid var(--border)",borderTopColor:"var(--cyan)",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 16px"}}/>
        <div style={{color:"var(--sub)",fontSize:14}}>Loading...</div>
      </div>
    </div>;
  }

  if (!user) return <LoginPage onSignIn={handleSignIn}/>;

  return(
    <div style={{background:"var(--bg0)",minHeight:"100vh",color:"var(--text)"}}>
      {/* HEADER */}
      <header style={{background:"var(--bg1)",borderBottom:"1px solid var(--border)",padding:"12px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:12,position:"sticky",top:0,zIndex:200}}>
        <div style={{display:"flex",alignItems:"center",gap:13}}>
          <div style={{width:38,height:38,borderRadius:10,background:"linear-gradient(135deg,#00d4c8,#004d4a)",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 0 18px rgba(0,212,200,.3)",flexShrink:0}}>
            <Ico n="layers" s={18} col="var(--bg0)"/>
          </div>
          <div>
            <div style={{fontFamily:"'Roboto',sans-serif",fontWeight:900,fontSize:16,letterSpacing:"-0.02em"}}>LabTrack</div>
            <div style={{color:"var(--dim)",fontSize:10,fontFamily:"'IBM Plex Mono',monospace"}}>robotics Â· inventory Â· v4.0</div>
          </div>
        </div>
        <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
          {overdues.length>0&&(
            <div className="overdue-pulse" style={{display:"flex",alignItems:"center",gap:6,background:"var(--red-d)",border:"1px solid #ff4d6a44",borderRadius:20,padding:"5px 12px",fontSize:12,color:"var(--red)"}}>
              <Ico n="clock" s={13} col="var(--red)"/>{overdues.length} overdue
            </div>
          )}
          {lowStock.length>0&&(
            <div style={{display:"flex",alignItems:"center",gap:6,background:"var(--amber-d)",border:"1px solid #f5a62344",borderRadius:20,padding:"5px 12px",fontSize:12,color:"var(--amber)"}}>
              <Ico n="alert" s={13} col="var(--amber)"/>{lowStock.length} low stock
            </div>
          )}
          {/* Theme toggle */}
          <button onClick={()=>setDarkMode(d=>!d)} title={darkMode?"Switch to Light Mode":"Switch to Dark Mode"}
            style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:8,padding:"7px 9px",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--sub)",transition:"all .15s"}}
            className="ibtn">
            <Ico n={darkMode?"sun":"moon"} s={14}/>
          </button>
          {/* Admin: Send Digest Now */}
          {userRole==="admin"&&APP_CONFIG.apps_script_url&&(
            <button onClick={handleSendDigest} title="Send Slack digest now (admin)"
              style={{background:"var(--purple-d)",border:"1px solid #b47dff33",borderRadius:8,padding:"6px 11px",cursor:"pointer",display:"flex",alignItems:"center",gap:5,color:"var(--purple)",fontSize:12,fontWeight:600,fontFamily:"'Outfit',sans-serif"}}>
              <Ico n="bell2" s={13} col="var(--purple)"/>Digest
            </button>
          )}
          <div style={{display:"flex",alignItems:"center",gap:8,background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:8,padding:"5px 12px 5px 6px"}}>
            {user.picture ? (
              <img src={user.picture} alt="" style={{width:28,height:28,borderRadius:"50%",border:"2px solid var(--border-hi)"}} onError={e=>{e.target.style.display='none';}}/>
            ) : (<MemberAvatar name={user.name} sz={28}/>)}
            <span style={{color:"var(--sub)",fontSize:12,fontWeight:500,maxWidth:120,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.name}</span>
            {userRole==="admin"&&<span style={{background:"var(--amber-d)",color:"var(--amber)",border:"1px solid #f5a62340",borderRadius:6,padding:"1px 6px",fontSize:9,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace",letterSpacing:"0.05em"}}>ADMIN</span>}
            <button onClick={()=>setModal("help")} title="Help & Onboarding" style={{background:"none",border:"1px solid var(--border)",color:"var(--dim)",cursor:"pointer",padding:"3px 8px",borderRadius:8,fontSize:12,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace"}}>?</button>
            <button onClick={handleSignOut} title="Sign out" style={{background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:"2px",display:"flex",alignItems:"center"}}><Ico n="logout" s={14}/></button>
          </div>
        </div>
      </header>

      {/* NAV */}
      <nav style={{background:"var(--bg1)",borderBottom:"1px solid var(--border)",padding:"0 24px",display:"flex",gap:2}}>
        {TABS.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)} style={{background:"transparent",border:"none",borderBottom:`2px solid ${tab===t.id?"var(--cyan)":"transparent"}`,color:tab===t.id?"var(--cyan)":"var(--dim)",padding:"13px 16px",cursor:"pointer",fontSize:13,fontWeight:600,display:"flex",alignItems:"center",gap:7,fontFamily:"'Outfit',sans-serif",transition:"color .15s,border-color .15s"}}>
            <Ico n={t.n} s={14} col={tab===t.id?"var(--cyan)":"var(--dim)"}/>{t.l}
            {t.count>0&&<span style={{background:t.id==="usage"&&overdues.length>0?"var(--red)":tab===t.id?"var(--cyan)":"var(--bg4)",color:t.id==="usage"&&overdues.length>0?"#000":tab===t.id?"#000":"var(--sub)",borderRadius:10,padding:"1px 6px",fontSize:10,fontWeight:800,fontFamily:"'IBM Plex Mono',monospace"}}>{t.count}</span>}
          </button>
        ))}
      </nav>

      {/* Session expired banner */}
      {sessionExpired&&(
        <div style={{background:"#7c2d12",borderBottom:"1px solid #dc262660",padding:"10px 24px",display:"flex",alignItems:"center",gap:10,justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <Ico n="alert" s={16} col="#fca5a5"/>
            <span style={{color:"#fca5a5",fontSize:13,fontWeight:600}}>Session expired â€” your data is saved. Please sign in again to sync changes.</span>
          </div>
          <button onClick={()=>{try{google.accounts.id.prompt();}catch(e){handleSignOut();}}} style={{background:"#dc2626",color:"#fff",border:"none",borderRadius:8,padding:"6px 14px",fontSize:12,fontWeight:700,cursor:"pointer",whiteSpace:"nowrap"}}>Sign In Again</button>
        </div>
      )}

      {/* Loading overlay */}
      {fetchingData && (
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",padding:"60px 20px",flexDirection:"column",gap:16}}>
          <div style={{width:40,height:40,border:"3px solid var(--border)",borderTopColor:"var(--cyan)",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>
          <div style={{color:"var(--sub)",fontSize:14}}>Fetching inventory data...</div>
        </div>
      )}

      {!fetchingData && (
      <main style={{padding:"24px",maxWidth:1360,margin:"0 auto"}}>

        {/* Stats */}
        <div style={{display:"flex",gap:12,marginBottom:overdues.length||lowStock.length?16:24,flexWrap:"wrap"}}>
          <Stat label="Total Items" val={items.length} icon="box" ac="var(--cyan)" sub="in inventory"/>
          <Stat label="Categories" val={[...new Set(items.map(i=>i.cat))].length} icon="layers" ac="var(--purple)" sub="active types"/>
          <Stat label="Orders" val={activeOrders.length} icon="cart" ac="var(--amber)" sub="in pipeline"/>
          <Stat label="Checked Out" val={activeOut.length} icon="users" ac="var(--blue)" sub="active"/>
          <Stat label="Overdue" val={overdues.length} icon="clock" ac={overdues.length?"var(--red)":"var(--green)"} sub="past return date" warn={overdues.length>0}/>
        </div>

        {/* Alert banners */}
        {overdues.length>0&&(
          <div style={{background:"var(--red-d)",border:"1px solid #ff4d6a30",borderRadius:10,padding:"10px 16px",marginBottom:12,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
            <Ico n="clock" s={15} col="var(--red)"/>
            <span style={{color:"var(--red)",fontSize:13,fontWeight:600}}>Overdue returns:</span>
            <span style={{color:"var(--sub)",fontSize:13}}>{overdues.map(c=>`${c.item} (${c.user})`).join(" Â· ")}</span>
            <Btn v="ghost" sm style={{marginLeft:"auto"}} onClick={()=>setTab("usage")}>View in Usage â†’</Btn>
          </div>
        )}
        {lowStock.length>0&&(
          <div style={{background:"var(--amber-d)",border:"1px solid #f5a62330",borderRadius:10,padding:"10px 16px",marginBottom:24,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
            <Ico n="alert" s={15} col="var(--amber)"/>
            <span style={{color:"var(--amber)",fontSize:13,fontWeight:600}}>Low stock:</span>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              {lowStock.map(i=>(
                <button key={i.id} onClick={()=>{setDetail(i);setTab("inventory");}} style={{background:"var(--amber-d)",color:"var(--amber)",border:"1px solid #f5a62340",borderRadius:12,padding:"2px 10px",fontSize:12,cursor:"pointer",fontWeight:600}}>
                  {i.name} ({i.qty} {i.unit})
                </button>
              ))}
            </div>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â• INVENTORY TAB â•â•â•â•â•â•â•â• */}
        {tab==="inventory"&&(
          <div style={{animation:"fadeUp .3s ease"}}>
            <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
              <div style={{position:"relative",flex:1,minWidth:200,maxWidth:320}}>
                <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)"}}><Ico n="search" s={14} col="var(--dim)"/></span>
                <Inp placeholder="Search name, location, serial..." value={search} onChange={e=>setSearch(e.target.value)} style={{paddingLeft:34}}/>
                {search&&<button onClick={()=>setSearch("")} style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:"var(--dim)",cursor:"pointer",padding:0,display:"flex"}}><Ico n="x" s={13}/></button>}
              </div>

              <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}>
                {["All",...categories].map(c=>{
                  const count=c==="All"?items.length:items.filter(i=>i.cat===c).length;
                  if(count===0&&c!=="All")return null;
                  const isSel=catF===c;
                  const ac=getCatAccent(c,categories);
                  return(
                    <button key={c} onClick={()=>setCatF(c)} style={{background:isSel?(c==="All"?"var(--bg4)":`${ac}18`):"var(--bg2)",color:isSel?(c==="All"?"var(--text)":ac):"var(--sub)",border:`1px solid ${isSel?(c==="All"?"var(--border-hi)":ac):"var(--border)"}`,borderRadius:20,padding:"4px 11px",fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"'Outfit',sans-serif",transition:"all .15s",display:"flex",alignItems:"center",gap:4}}>
                      {c}{c!=="All"&&<span style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:10,opacity:.7}}>{count}</span>}
                    </button>
                  );
                })}
                <button onClick={()=>setModal("manageCategories")} title="Manage Categories" style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:20,padding:"4px 8px",cursor:"pointer",display:"flex",alignItems:"center",transition:"all .15s"}}>
                  <Ico n="settings" s={13} col="var(--dim)"/>
                </button>
              </div>

              {/* Sort */}
              <Sel value={sortBy} onChange={e=>setSortBy(e.target.value)} style={{width:"auto",padding:"6px 10px",fontSize:12,borderRadius:8}}>
                <option value="name-az">Name A-Z</option>
                <option value="name-za">Name Z-A</option>
                <option value="newest">Newest</option>
                <option value="qty-low">Qty Lowâ†’High</option>
                <option value="qty-high">Qty Highâ†’Low</option>
              </Sel>

              <div style={{display:"flex",gap:2,background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:8,padding:3,marginLeft:"auto"}}>
                {["grid","list"].map(v=>(
                  <button key={v} onClick={()=>setView(v)} style={{background:view===v?"var(--bg4)":"transparent",border:view===v?"1px solid var(--border-hi)":"1px solid transparent",borderRadius:6,padding:"5px 9px",cursor:"pointer",display:"flex",alignItems:"center",transition:"all .15s"}}>
                    <Ico n={v} s={15} col={view===v?"var(--cyan)":"var(--dim)"}/>
                  </button>
                ))}
              </div>

              <Btn v="ghost" onClick={()=>{setPreItem("");setModal("checkout");}}><Ico n="tag" s={14}/>Check Out</Btn>
              <Btn onClick={()=>setModal("addItem")}><Ico n="plus" s={14} col="#000"/>Add Item</Btn>
            </div>

            {search&&<div style={{color:"var(--dim)",fontSize:12,marginBottom:12}}>{filtered.length} result{filtered.length!==1?"s":""} for "{search}"</div>}

            {filtered.length===0?(
              <div style={{textAlign:"center",padding:"60px 20px",color:"var(--dim)"}}>
                <Ico n={items.length===0?"box":"search"} s={48} col="var(--bg4)"/>
                <div style={{marginTop:16,fontSize:16,color:"var(--sub)"}}>{items.length===0?"No items in inventory yet":"No items found"}</div>
                <div style={{fontSize:13,marginTop:4}}>{items.length===0?"Add your first item to get started":"Try a different search or category"}</div>
                {items.length===0 ? (
                  <Btn style={{marginTop:16}} onClick={()=>setModal("addItem")}><Ico n="plus" s={14} col="#000"/>Add First Item</Btn>
                ) : (
                  <button onClick={()=>{setSearch("");setCatF("All");}} style={{marginTop:16,background:"none",border:"1px solid var(--border)",color:"var(--cyan)",borderRadius:8,padding:"7px 16px",cursor:"pointer",fontSize:13}}>Clear filters</button>
                )}
              </div>
            ):view==="grid"?(
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(238px,1fr))",gap:14}}>
                {paginatedItems.map((item,idx)=>{
                  const ac=getCatAccent(item.cat,categories);
                  const isLow=item.qty<=item.minQty;
                  return(
                    <div key={item.id} className="card-item" onClick={()=>setDetail(item)} style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14,overflow:"hidden",animation:`fadeUp .3s ease ${Math.min(idx,.8)*0.04}s both`}}>
                      <div style={{position:"relative"}}>
                        <img src={item.img||`https://placehold.co/280x112/141b24/3d5068?text=${encodeURIComponent(item.cat)}`} alt={item.name} style={{width:"100%",height:112,objectFit:"cover",display:"block"}}/>
                        <div style={{position:"absolute",bottom:0,left:0,right:0,height:44,background:"linear-gradient(transparent,var(--bg1))"}}/>
                        <div style={{position:"absolute",top:10,right:10}}><Badge status={isLow?"Low Stock":item.status}/></div>
                        <div style={{position:"absolute",top:10,left:10,background:"rgba(7,9,15,.78)",borderRadius:7,padding:"3px 8px"}}>
                          <span style={{color:ac,fontSize:9,fontWeight:700,fontFamily:"'IBM Plex Mono',monospace",letterSpacing:"0.08em"}}>{(item.cat||"").toUpperCase()}</span>
                        </div>
                      </div>
                      <div style={{padding:"11px 14px 13px"}}>
                        <div style={{fontWeight:700,fontSize:14,color:"var(--text)",marginBottom:2,fontFamily:"'Roboto',sans-serif",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{item.name}</div>
                        <div style={{color:"var(--dim)",fontSize:11,marginBottom:4,fontFamily:"'IBM Plex Mono',monospace",display:"flex",gap:8,flexWrap:"wrap"}}>
                          {item.displayId&&<span style={{background:"var(--bg3)",border:"1px solid var(--border)",borderRadius:4,padding:"0px 5px",color:"var(--cyan)",letterSpacing:"0.05em"}}>{item.displayId}</span>}
                          {item.shared&&<span style={{color:"var(--purple)",fontSize:10}}>SHARED</span>}
                          {item.consumable&&<span style={{color:"var(--amber)",fontSize:10}}>CONSUMABLE</span>}
                        </div>
                        <div style={{color:"var(--dim)",fontSize:11,marginBottom:10,fontFamily:"'IBM Plex Mono',monospace"}}>{item.loc||"â€”"}{item.serial?` Â· S/N: ${item.serial}`:""}</div>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                          <div style={{display:"flex",alignItems:"baseline",gap:4}}>
                            <span style={{color:isLow?"var(--red)":ac,fontFamily:"'Roboto',sans-serif",fontSize:24,fontWeight:900,lineHeight:1,letterSpacing:"-0.02em"}}>{item.qty}</span>
                            <span style={{color:"var(--dim)",fontSize:11}}>{item.unit}</span>
                          </div>
                          {item.consumable?(
                            <button onClick={e=>{e.stopPropagation();const n=parseInt(window.prompt(`How many ${item.unit} used?`,"1"));if(!isNaN(n)&&n>0)handleUseConsumable(item.id,n);}} style={{background:"var(--amber-d)",color:"var(--amber)",border:"1px solid #f5a62330",borderRadius:6,padding:"3px 10px",fontSize:11,fontWeight:700,cursor:"pointer"}}>Use</button>
                          ):item.usedBy?.length>0?(
                            <div style={{display:"flex"}}>{item.usedBy.slice(0,3).map((u,i)=><div key={u} style={{marginLeft:i>0?-8:0,zIndex:3-i}}><MemberAvatar name={u} sz={24}/></div>)}</div>
                          ):null}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ):(
              <div style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14,overflow:"hidden"}}>
                <div style={{overflow:"auto",maxHeight:"65vh"}}>
                  <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                    <thead><tr style={{borderBottom:"1px solid var(--border)"}}>
                      {["Item","Category","Stock","Location","Serial","Status","In Use By"].map(h=>(
                        <th key={h} className="sticky-th" style={{padding:"11px 16px",textAlign:"left",color:"var(--dim)",fontSize:10,fontWeight:700,letterSpacing:"0.1em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{h}</th>
                      ))}
                    </tr></thead>
                    <tbody>
                      {paginatedItems.map((item,i)=>(
                        <tr key={item.id} className="row-hover" onClick={()=>setDetail(item)} style={{borderBottom:i<paginatedItems.length-1?"1px solid var(--border)":"none",cursor:"pointer",transition:"background .15s"}}>
                          <td style={{padding:"10px 16px",color:"var(--text)",fontWeight:600}}>{item.name}</td>
                          <td style={{padding:"10px 16px"}}><span style={{color:getCatAccent(item.cat,categories),fontSize:12}}>{item.cat}</span></td>
                          <td style={{padding:"10px 16px",fontFamily:"'IBM Plex Mono',monospace",color:item.qty<=item.minQty?"var(--red)":"var(--text)",fontWeight:600}}>{item.qty} <span style={{color:"var(--dim)",fontWeight:400}}>{item.unit}</span></td>
                          <td style={{padding:"10px 16px",color:"var(--sub)",fontSize:12}}>{item.loc||"â€”"}</td>
                          <td style={{padding:"10px 16px",color:"var(--dim)",fontSize:11,fontFamily:"'IBM Plex Mono',monospace"}}>{item.serial||"â€”"}</td>
                          <td style={{padding:"10px 16px"}}><Badge status={item.qty<=item.minQty?"Low Stock":item.status}/></td>
                          <td style={{padding:"10px 16px"}}>{item.usedBy?.length>0?<div style={{display:"flex",gap:4}}>{item.usedBy.slice(0,3).map(u=><MemberAvatar key={u} name={u} sz={24}/>)}</div>:<span style={{color:"var(--dim)"}}>â€”</span>}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            <Pagination total={filtered.length} page={page} setPage={setPage}/>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â• ORDER REQUESTS TAB â•â•â•â•â•â•â•â• */}
        {tab==="orders"&&(
          <div style={{animation:"fadeUp .3s ease"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12}}>
              <div>
                <h2 style={{margin:"0 0 3px",fontFamily:"'Roboto',sans-serif",fontSize:18,fontWeight:700}}>Order Requests</h2>
                <p style={{margin:0,color:"var(--sub)",fontSize:13}}>{activeOrders.length} active Â· {pendingOrders} pending approval Â· {deliveries.length} deliveries</p>
              </div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}}>
                {activeOrders.length>0&&(
                  <Btn v="ghost" sm onClick={()=>{
                    if(selectedOrders.size===activeOrders.length){setSelectedOrders(new Set());}
                    else{setSelectedOrders(new Set(activeOrders.map(o=>String(o.id))));}
                  }}>
                    {selectedOrders.size===activeOrders.length?"Deselect All":"Select All"}
                  </Btn>
                )}
                {selectedOrders.size>0&&(
                  <Btn v="amber" onClick={()=>{
                    const text=generateEmailText(activeOrders.filter(o=>selectedOrders.has(String(o.id))));
                    const w=window.open('','_blank','width=720,height=520,resizable=yes,scrollbars=yes');
                    if(w){
                      w.document.write('<html><head><title>Purchase Request Email</title></head><body style="margin:0;padding:24px;font-family:monospace;background:#111;color:#eee"><h3 style="font-family:sans-serif;color:#00d4c8;margin:0 0 16px">&#x1F4E7; Purchase Request &#x2014; select all and copy (Ctrl+A &#x2192; Ctrl+C)</h3><pre id="t" style="white-space:pre-wrap;font-size:13px;line-height:1.8;background:#1a1a1a;padding:20px;border-radius:8px"></pre></body></html>');
                      w.document.close();
                      w.document.getElementById('t').textContent=text;
                    }
                    else{setEmailText(text);setModal("emailText");}
                  }}>
                    <Ico n="mail" s={14} col="var(--amber)"/>Email Text ({selectedOrders.size})
                  </Btn>
                )}
                <Btn v="ghost" onClick={()=>setModal("delivery")}><Ico n="truck" s={14}/>Log Delivery</Btn>
                <Btn onClick={()=>setModal("order")}><Ico n="cart" s={14} col="#000"/>New Request</Btn>
              </div>
            </div>

            {/* Active Orders */}
            <div style={{marginBottom:28}}>
              <h3 style={{fontFamily:"'Roboto',sans-serif",fontWeight:700,fontSize:15,marginBottom:12,color:"var(--text)"}}>Active Orders</h3>
              {activeOrders.length===0?(
                <div style={{textAlign:"center",padding:"40px 20px",color:"var(--dim)",background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14}}>
                  <Ico n="cart" s={40} col="var(--bg4)"/>
                  <div style={{marginTop:12,fontSize:14,color:"var(--sub)"}}>No active orders</div>
                  <div style={{fontSize:12,marginTop:4}}>Request supplies or equipment your lab needs</div>
                  <Btn style={{marginTop:12}} onClick={()=>setModal("order")}><Ico n="plus" s={14} col="#000"/>Submit first request</Btn>
                </div>
              ):(
                <div style={{display:"flex",flexDirection:"column",gap:10}}>
                  {activeOrders.map((o,idx)=>{
                    const urgColors={Urgent:{bg:"var(--red-d)",col:"var(--red)"},High:{bg:"var(--amber-d)",col:"var(--amber)"},Normal:{bg:"var(--blue-d)",col:"var(--blue)"},Low:{bg:"var(--bg3)",col:"var(--dim)"}};
                    const uc=urgColors[o.urgency]||urgColors.Normal;
                    const statusColors={Pending:{bg:"var(--amber-d)",col:"var(--amber)"},Approved:{bg:"var(--blue-d)",col:"var(--blue)"},Ordered:{bg:"var(--purple-d)",col:"var(--purple)"}};
                    const sc=statusColors[o.status]||statusColors.Pending;
                    const nextStatus={Pending:"Approved",Approved:"Ordered",Ordered:"Received"};
                    const ns=nextStatus[o.status];
                    const isSel=selectedOrders.has(String(o.id));
                    return(
                      <div key={o.id} onClick={()=>{const sel=new Set(selectedOrders);sel.has(String(o.id))?sel.delete(String(o.id)):sel.add(String(o.id));setSelectedOrders(sel);}} style={{background:isSel?"var(--cyan-d)":"var(--bg1)",border:`1px solid ${isSel?"var(--cyan)":"var(--border)"}`,borderRadius:12,padding:"16px 20px",animation:`fadeUp .3s ease ${idx*.04}s both`,cursor:"pointer",transition:"background .15s,border-color .15s"}}>
                        <div style={{display:"flex",alignItems:"flex-start",gap:14,flexWrap:"wrap"}}>
                          <div style={{paddingTop:2,flexShrink:0}} onClick={e=>e.stopPropagation()}>
                            <input type="checkbox" checked={isSel} onChange={()=>{const sel=new Set(selectedOrders);sel.has(String(o.id))?sel.delete(String(o.id)):sel.add(String(o.id));setSelectedOrders(sel);}} style={{width:16,height:16,cursor:"pointer",accentColor:"var(--cyan)"}}/>
                          </div>
                          <div style={{flex:1,minWidth:200}}>
                            <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:6,flexWrap:"wrap"}}>
                              <span style={{fontWeight:700,fontSize:15,color:"var(--text)",fontFamily:"'Roboto',sans-serif"}}>{o.item}</span>
                              <span style={{background:sc.bg,color:sc.col,border:`1px solid ${sc.col}30`,padding:"2px 9px",borderRadius:20,fontSize:10,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{o.status}</span>
                              <span style={{background:uc.bg,color:uc.col,border:`1px solid ${uc.col}30`,padding:"2px 8px",borderRadius:20,fontSize:10,fontWeight:600,fontFamily:"'IBM Plex Mono',monospace"}}>{o.urgency}</span>
                              {o.cat&&<span style={{color:getCatAccent(o.cat,categories),fontSize:11,fontFamily:"'IBM Plex Mono',monospace"}}>{o.cat}</span>}
                            </div>
                            <div style={{color:"var(--sub)",fontSize:12,marginBottom:4}}>
                              <span style={{fontFamily:"'IBM Plex Mono',monospace"}}>{o.qty} {o.unit}</span>
                              {o.price&&<span> Â· {o.price}</span>}
                              {o.store&&<span> Â· <strong style={{color:"var(--text)"}}>{o.store}</strong></span>}
                              {o.requestedBy&&<span> Â· by <strong>{o.requestedBy}</strong></span>}
                              {o.date&&<span> Â· need by {o.date}</span>}
                            </div>
                            {o.reason&&<div style={{color:"var(--dim)",fontSize:12,fontStyle:"italic",marginBottom:4}}>{o.reason}</div>}
                            {o.link&&<a href={o.link} target="_blank" rel="noopener noreferrer" onClick={e=>e.stopPropagation()} style={{color:"var(--cyan)",fontSize:12,display:"inline-flex",alignItems:"center",gap:4}}><Ico n="link" s={11} col="var(--cyan)"/>Purchase link</a>}
                          </div>
                          <div style={{display:"flex",gap:6,flexShrink:0,flexWrap:"wrap"}} onClick={e=>e.stopPropagation()}>
                            <Btn sm v="ghost" onClick={()=>setEditOrder(o)}><Ico n="edit" s={12}/>Edit</Btn>
                            {userRole==="admin"&&ns&&(
                              <Btn sm v={ns==="Received"?"success":"ghost"} onClick={()=>{
                                if(ns==="Received"){ handleOrderReceived(o); }
                                else { handleUpdateOrderStatus(o.id,ns); }
                              }}>
                                {ns==="Received"?<><Ico n="check" s={12} col="var(--green)"/>Mark Received</>:<>{ns} â†’</>}
                              </Btn>
                            )}
                            {userRole==="admin"&&o.status==="Pending"&&<Btn sm v="danger" onClick={()=>handleUpdateOrderStatus(o.id,"Rejected")}>Reject</Btn>}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Completed Orders */}
            {receivedOrders.length>0&&(
              <div style={{marginBottom:28}}>
                <h3 style={{fontFamily:"'Roboto',sans-serif",fontWeight:700,fontSize:15,marginBottom:12,color:"var(--text)"}}>Completed Orders</h3>
                <div style={{display:"flex",flexDirection:"column",gap:6}}>
                  {receivedOrders.map(o=>{
                    const sc2=o.status==="Received"?{bg:"var(--green-d)",col:"var(--green)"}:{bg:"var(--red-d)",col:"var(--red)"};
                    return(
                      <div key={o.id} style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:10,padding:"10px 16px",display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"}}>
                        <span style={{fontWeight:600,fontSize:13,color:"var(--text)",flex:1}}>{o.item}</span>
                        <span style={{fontFamily:"'IBM Plex Mono',monospace",fontSize:11,color:"var(--dim)"}}>{o.qty} {o.unit}</span>
                        <span style={{background:sc2.bg,color:sc2.col,border:`1px solid ${sc2.col}30`,padding:"2px 9px",borderRadius:20,fontSize:10,fontWeight:700,letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{o.status}</span>
                        <Btn sm v="ghost" onClick={()=>handleDeleteOrder(o.id)}><Ico n="trash" s={12}/></Btn>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Delivery Log */}
            <div>
              <h3 style={{fontFamily:"'Roboto',sans-serif",fontWeight:700,fontSize:15,marginBottom:12,color:"var(--text)"}}>Delivery Log</h3>
              {deliveries.length===0?(
                <div style={{textAlign:"center",padding:"40px 20px",color:"var(--dim)",background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14}}>
                  <Ico n="truck" s={40} col="var(--bg4)"/>
                  <div style={{marginTop:12,fontSize:14,color:"var(--sub)"}}>No deliveries logged yet</div>
                </div>
              ):(
                <div style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14,overflow:"hidden"}}>
                  <div style={{overflow:"auto"}}>
                    <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                      <thead><tr style={{borderBottom:"1px solid var(--border)"}}>{["Item","Qty","Supplier","Received By","Tracking","Date","Status"].map(h=><th key={h} className="sticky-th" style={{padding:"11px 16px",textAlign:"left",color:"var(--dim)",fontSize:10,fontWeight:700,letterSpacing:"0.1em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{h}</th>)}</tr></thead>
                      <tbody>{deliveries.map((d,i)=>(
                        <tr key={d.id} className="row-hover" style={{borderBottom:i<deliveries.length-1?"1px solid var(--border)":"none",transition:"background .15s"}}>
                          <td style={{padding:"11px 16px",color:"var(--text)",fontWeight:600}}>{d.item}</td>
                          <td style={{padding:"11px 16px",color:"var(--sub)",fontFamily:"'IBM Plex Mono',monospace"}}>{d.qty} {d.unit}</td>
                          <td style={{padding:"11px 16px",color:"var(--sub)"}}>{d.from||"â€”"}</td>
                          <td style={{padding:"11px 16px"}}>{d.receivedBy?<div style={{display:"flex",alignItems:"center",gap:7}}><MemberAvatar name={d.receivedBy} sz={24}/><span style={{color:"var(--sub)"}}>{d.receivedBy}</span></div>:<span style={{color:"var(--dim)"}}>â€”</span>}</td>
                          <td style={{padding:"11px 16px",color:"var(--dim)",fontFamily:"'IBM Plex Mono',monospace",fontSize:11}}>{d.tracking||"â€”"}</td>
                          <td style={{padding:"11px 16px",color:"var(--dim)",fontFamily:"'IBM Plex Mono',monospace",fontSize:11}}>{d.date}</td>
                          <td style={{padding:"11px 16px"}}><Badge status={d.status}/></td>
                        </tr>
                      ))}</tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â• USAGE TAB â•â•â•â•â•â•â•â• */}
        {tab==="usage"&&(
          <div style={{animation:"fadeUp .3s ease"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20,flexWrap:"wrap",gap:12}}>
              <div>
                <h2 style={{margin:"0 0 3px",fontFamily:"'Roboto',sans-serif",fontSize:18,fontWeight:700}}>Item Usage</h2>
                <p style={{margin:0,color:"var(--sub)",fontSize:13}}>{activeOut.length} active Â· {overdues.length>0&&<span style={{color:"var(--red)",fontWeight:600}}>{overdues.length} overdue Â· </span>}Slack notifies on checkout & return</p>
              </div>
              <div style={{display:"flex",gap:8}}>
                {selected.size>0&&(
                  <Btn v="success" onClick={()=>setConfirm({msg:`Return ${selected.size} selected item${selected.size>1?"s":""}?`,onConfirm:handleBulkReturn})}>
                    <Ico n="undo" s={14} col="var(--green)"/>Return {selected.size} selected
                  </Btn>
                )}
                <Btn onClick={()=>{setPreItem("");setModal("checkout");}}><Ico n="plus" s={14} col="#000"/>New Checkout</Btn>
              </div>
            </div>

            {activeOut.length===0 && checkouts.length===0 ? (
              <div style={{textAlign:"center",padding:"60px 20px",color:"var(--dim)",background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14}}>
                <Ico n="users" s={48} col="var(--bg4)"/>
                <div style={{marginTop:16,fontSize:16,color:"var(--sub)"}}>No checkouts yet</div>
                <div style={{fontSize:13,marginTop:4}}>Check out items to track who is using what</div>
              </div>
            ) : (
              <>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(255px,1fr))",gap:14,marginBottom:28}}>
              {[...new Set(checkouts.filter(c=>c.status==="Active").map(c=>c.user))].map((m,idx)=>{
                const outs=checkouts.filter(c=>c.user===m&&c.status==="Active");
                const od=outs.filter(c=>isOverdue(c)).length;
                return(
                  <div key={m} style={{background:"var(--bg1)",border:`1px solid ${od?"#ff4d6a30":"var(--border)"}`,borderRadius:14,padding:"16px 18px",animation:`fadeUp .3s ease ${idx*.05}s both`}}>
                    <div style={{display:"flex",alignItems:"center",gap:11,marginBottom:12}}>
                      <MemberAvatar name={m} sz={40}/>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontWeight:700,fontSize:14,fontFamily:"'Roboto',sans-serif"}}>{m}</div>
                        <div style={{color:od?"var(--red)":outs.length?"var(--blue)":"var(--dim)",fontSize:12}}>
                          {od?`${od} overdue!`:outs.length?`${outs.length} item${outs.length>1?"s":""} out`:"Nothing checked out"}
                        </div>
                      </div>
                    </div>
                    {outs.map(c=>{
                      const od2=isOverdue(c);
                      return(
                        <div key={c.id} style={{background:od2?"var(--red-d)":"var(--bg2)",border:`1px solid ${od2?"#ff4d6a30":"var(--border)"}`,borderRadius:8,padding:"8px 11px",marginBottom:6,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8}}>
                          <div style={{minWidth:0}}>
                            <div style={{color:"var(--text)",fontSize:13,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{c.item}</div>
                            <div style={{color:od2?"var(--red)":"var(--dim)",fontSize:10,fontFamily:"'IBM Plex Mono',monospace",marginTop:2}}>{od2?"OVERDUE":"Return"} {c.ret||"â€”"}</div>
                          </div>
                          <Btn v="ghost" sm onClick={()=>setConfirm({msg:`Return "${c.item}" from ${c.user}?`,onConfirm:()=>handleReturn(c.id)})}><Ico n="undo" s={11}/></Btn>
                        </div>
                      );
                    })}
                  </div>
                );
              })}
            </div>

            <div style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14,overflow:"hidden"}}>
              <div style={{padding:"13px 18px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span style={{fontWeight:700,fontFamily:"'Roboto',sans-serif",fontSize:15}}>All Records</span>
                {selected.size>0&&<span style={{color:"var(--cyan)",fontSize:12,fontFamily:"'IBM Plex Mono',monospace"}}>{selected.size} selected</span>}
              </div>
              <div style={{overflow:"auto",maxHeight:"65vh"}}>
                <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                  <thead><tr style={{borderBottom:"1px solid var(--border)"}}>
                    <th className="sticky-th" style={{padding:"10px 16px",width:36}}/>
                    {["Item","Person","Checked Out","Return By","Status",""].map((h,i)=>(
                      <th key={i} className="sticky-th" style={{padding:"10px 16px",textAlign:"left",color:"var(--dim)",fontSize:10,fontWeight:700,letterSpacing:"0.1em",textTransform:"uppercase",fontFamily:"'IBM Plex Mono',monospace"}}>{h}</th>
                    ))}
                  </tr></thead>
                  <tbody>{checkouts.map((c,i)=>{
                    const od=isOverdue(c);const isSel=selected.has(c.id);
                    return(
                      <tr key={c.id} className="row-hover" style={{borderBottom:i<checkouts.length-1?"1px solid var(--border)":"none",transition:"background .15s",background:od?"rgba(45,0,16,.4)":isSel?"var(--cyan-d)":undefined}}>
                        <td style={{padding:"10px 16px"}}>{c.status==="Active"&&<input type="checkbox" checked={isSel} onChange={e=>{const ns=new Set(selected);e.target.checked?ns.add(c.id):ns.delete(c.id);setSelected(ns);}} style={{cursor:"pointer",accentColor:"var(--cyan)"}}/>}</td>
                        <td style={{padding:"10px 16px",color:"var(--text)",fontWeight:600}}>{c.item}</td>
                        <td style={{padding:"10px 16px"}}><div style={{display:"flex",alignItems:"center",gap:8}}><MemberAvatar name={c.user} sz={26}/><span style={{color:"var(--sub)"}}>{c.user}</span></div></td>
                        <td style={{padding:"10px 16px",color:"var(--dim)",fontFamily:"'IBM Plex Mono',monospace",fontSize:11}}>{c.out}</td>
                        <td style={{padding:"10px 16px",color:od?"var(--red)":"var(--dim)",fontFamily:"'IBM Plex Mono',monospace",fontSize:11,fontWeight:od?700:400}}>{c.ret||"â€”"}{od&&" !"}</td>
                        <td style={{padding:"10px 16px"}}><Badge status={od?"Overdue":c.status}/></td>
                        <td style={{padding:"10px 16px"}}>{c.status==="Active"&&<Btn v="ghost" sm onClick={()=>setConfirm({msg:`Return "${c.item}" from ${c.user}?`,onConfirm:()=>handleReturn(c.id)})}><Ico n="undo" s={12}/>Return</Btn>}</td>
                      </tr>
                    );
                  })}</tbody>
                </table>
              </div>
            </div>
              </>
            )}
          </div>
        )}

        {/* â•â•â•â•â•â•â•â• CALENDAR TAB â•â•â•â•â•â•â•â• */}
        {tab==="calendar"&&(
          <div style={{animation:"fadeUp .3s ease"}}>
            <h2 style={{margin:"0 0 20px",fontFamily:"'Roboto',sans-serif",fontSize:18,fontWeight:700}}>Activity Calendar</h2>
            <div style={{background:"var(--bg1)",border:"1px solid var(--border)",borderRadius:14,padding:24}}>
              <CalView checkouts={checkouts} deliveries={deliveries}/>
            </div>
          </div>
        )}
      </main>
      )}

      {/* MODALS */}
      {modal==="delivery" && <DeliveryModal onClose={()=>setModal(null)} onAdd={handleDelivery} userName={user?.name||""}/>}
      {modal==="checkout" && <CheckoutModal items={items} onClose={()=>setModal(null)} onAdd={handleCheckout} preItem={preItem} userName={user?.name||""} categories={categories}/>}
      {modal==="addItem" && <AddItemModal onClose={()=>setModal(null)} onAdd={handleAddItem} categories={categories} allItems={items}/>}
      {modal==="order" && <OrderModal onClose={()=>setModal(null)} onAddMany={handleAddOrderMany} userName={user?.name||""} categories={categories}/>}
      {modal==="manageCategories" && <ManageCategoriesModal categories={categories} onSave={handleSaveCategories} onClose={()=>setModal(null)}/>}
      {editItem && <EditItemModal item={editItem} onClose={()=>setEditItem(null)} onSave={handleUpdateItem} onDelete={handleDeleteItem} categories={categories} isAdmin={userRole==="admin"}/>}
      {editOrder && <EditOrderModal order={editOrder} onClose={()=>setEditOrder(null)} onSave={handleUpdateOrder} isAdmin={userRole==="admin"} categories={categories}/>}
      {modal==="emailText"&&<Modal onClose={()=>{setModal(null);setEmailText("");}} title="ðŸ“§ Purchase Request Email Text" mw={700}>
        <p style={{color:"var(--sub)",fontSize:13,marginBottom:10}}>Select all and copy (Ctrl+A â†’ Ctrl+C), then paste into your email.</p>
        <textarea readOnly value={emailText} onClick={e=>e.target.select()} style={{width:"100%",height:260,background:"var(--bg2)",border:"1px solid var(--border)",color:"var(--text)",borderRadius:8,padding:"12px 14px",fontSize:12,fontFamily:"'IBM Plex Mono',monospace",resize:"vertical",outline:"none",lineHeight:1.8,display:"block"}}/>
        <div style={{display:"flex",justifyContent:"flex-end",marginTop:14}}>
          <Btn onClick={()=>{setModal(null);setEmailText("");}}>Done</Btn>
        </div>
      </Modal>}
      {pendingItem && <PendingItemModal order={pendingItem} allItems={items} categories={categories} onClose={()=>setPendingItem(null)} onConfirm={handleConfirmPendingItem}/>}
      {modal==="help" && <Modal onClose={()=>setModal(null)} title="LabTrack â€” Help & Guide" mw={640}>
        <div style={{display:"flex",flexDirection:"column",gap:20,fontSize:13}}>
          {[
            {icon:"box",title:"Inventory Tab",color:"var(--cyan)",items:["Add items with the + button. Fill in name, category, location, and quantity.","Set Min Stock to get a red Low Stock badge when qty drops to or below that number.","Shared items (e.g. toolboxes) stay Available when checked out â€” multiple people can use them simultaneously.","Consumable items (e.g. stickers, reagents) show a Use button on the card â€” enter quantity used to deduct without a formal checkout.","Each item gets a Label ID (e.g. RM-00001). Print it on a sticker and attach it to the physical item. Configure prefixes in Settings â†’ Manage Categories.","Click any item card to see full details, checkout history, and quick actions."]},
            {icon:"tag",title:"Usage / Checkout Tab",color:"var(--blue)",items:["Use Check Out to assign a non-consumable, non-shared item to a person. Enter qty, dates, and optional notes.","Shared items can be checked out by multiple people at the same time and remain Available.","Consumable items do not appear in the checkout list â€” use the Use button on the card instead.","Mark items Returned when done. Overdue checkouts are highlighted in red.","Bulk Return lets you return multiple items at once."]},
            {icon:"cart",title:"Order Requests Tab",color:"var(--amber)",items:["Submit purchase requests with store, item, link, qty, and price.","Select multiple orders with checkboxes â†’ Email Text generates a formatted purchase request table with per-item totals and a grand total â€” ready to paste into an email.","Admins can move orders through: Pending â†’ Approved â†’ Ordered â†’ Received.","When marked Received, a staging form opens â€” fill in location, label ID, and serial number before it is added to inventory.","Deliveries are automatically logged when an order is marked Received."]},
            {icon:"calendar",title:"Calendar Tab",color:"var(--purple)",items:["Visual monthly calendar showing deliveries, active checkouts, and return due dates.","Color-coded: green = delivery, blue = checkout start, amber = return due.","Click any day to see all events on that date."]},
            {icon:"layers",title:"Item Statuses",color:"var(--sub)",items:["ðŸŸ¢ Available â€” ready to use","ðŸ”µ In Use â€” checked out by one or more people","ðŸŸ¡ Maintenance â€” temporarily out of service","ðŸ”´ Broken â€” damaged or needs repair","âš ï¸ Low Stock â€” qty is at or below the Min Stock threshold (shown as a badge)"]},
            {icon:"settings",title:"Settings (Admin only)",color:"var(--orange)",items:["Manage Categories â€” add, remove, or rename categories; set label ID prefix per category (e.g. RM for Robots & Motors).","Admins list â€” edit in the Settings tab of the Google Sheet (JSON array of emails).","Slack notifications â€” set slack_mode in Settings tab: all | important | digest | off.","Session expires after ~1 hour and auto-renews silently. If you see a red banner at the top, click Sign In Again."]},
          ].map(s=>(
            <div key={s.title}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}><Ico n={s.icon} s={16} col={s.color}/><strong style={{color:s.color,fontFamily:"'Roboto',sans-serif"}}>{s.title}</strong></div>
              <ul style={{margin:0,paddingLeft:20,color:"var(--sub)",lineHeight:1.9}}>{s.items.map((it,i)=><li key={i}>{it}</li>)}</ul>
            </div>
          ))}
        </div>
      </Modal>}
      {detail && <ItemDetail item={detail} checkouts={checkouts} onClose={()=>setDetail(null)} onReturn={handleReturn} onQuickCheckout={handleQuickCheckout} onEdit={handleEditItem} categories={categories}/>}
      {confirm && <ConfirmModal msg={confirm.msg} onConfirm={confirm.onConfirm} onClose={()=>setConfirm(null)}/>}

      <ToastStack toasts={toasts} rm={id=>setToasts(t=>t.filter(x=>x.id!==id))}/>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(LabInventory));
</script>
</body>
</html>
